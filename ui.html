<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      color: #333;
      background: #fff;
      height: 368px; /* 400px - 32px padding */
      box-sizing: border-box;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tab-navigation {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 8px;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 8px 16px;
      margin-right: 8px;
      cursor: pointer;
      color: #666;
      font-weight: 500;
      border-radius: 4px;
    }

    .tab-button.active {
      background: #18A0FB;
      color: white;
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* Tracking Tab */
    #tracking-tab {
      gap: 16px;
    }

    .status-display {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .timer-display {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 16px 0;
    }

    .button-container {
      display: flex;
      gap: 8px;
    }

    button {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .start-button {
      background: #18A0FB;
      color: white;
    }

    .stop-button {
      background: #EB4D4D;
      color: white;
    }

    /* Summary Tab */
    #summary-tab {
      gap: 12px;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .summary-content {
      flex: 1;
      overflow: hidden;
    }

    .file-summary {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-summary:last-child {
      margin-bottom: 0;
    }

    .file-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .file-time {
      color: #666;
      font-size: 14px;
    }

    /* Settings Tab */
    #settings-tab {
      gap: 16px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .setting-label {
      font-size: 14px;
      color: #333;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #18A0FB;
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .minimize-button {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .minimize-button:hover {
      background-color: #f0f0f0;
    }
    
    .minimize-button svg {
      width: 16px;
      height: 16px;
    }
    
    .plugin-container {
      transition: all 0.3s ease;
      position: relative;
    }
    
    .plugin-container.minimized {
      height: 40px !important;
      overflow: hidden;
    }
    
    .minimized-view {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: #fff;
      border-bottom: 1px solid #e5e5e5;
      padding: 0 12px;
      align-items: center;
      justify-content: space-between;
    }
    
    .minimized-view.visible {
      display: flex;
    }
    
    .minimized-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .minimized-page {
      color: #666;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .minimized-time {
      font-weight: 500;
      color: #18A0FB;
    }

    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: #fff;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      z-index: 100;
    }

    .logo {
      font-weight: 600;
      font-size: 16px;
      color: #18A0FB;
      letter-spacing: 0.5px;
    }

    .minimize-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .minimize-button:hover {
      opacity: 1;
      background-color: #f0f0f0;
    }

    .container {
      margin-top: 40px; /* Add space for top bar */
    }

    /* Updated minimized view styles */
    .minimized-view {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 32px;
      background-color: #fff;
      padding: 0 12px;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
    }

    .minimized-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #4CAF50;
      animation: blink 2s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }

    .minimized-page {
      color: #333;
      font-weight: 500;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .plugin-container.minimized {
      height: 32px !important;
      overflow: hidden;
      border-radius: 6px;
      border: none;
    }
  </style>
</head>
<body>
  <div class="plugin-container">
    <!-- Top bar for full view -->
    <div class="top-bar">
      <div class="logo">HOURS</div>
      <button class="minimize-button" onclick="toggleMinimize()" title="Minimize">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 7H2V9H14V7Z" fill="#666"/>
        </svg>
      </button>
    </div>

    <!-- Minimized view -->
    <div class="minimized-view">
      <div class="minimized-info">
        <div class="status-dot"></div>
        <span class="minimized-page" id="minimized-page">No active page</span>
      </div>
      <button class="minimize-button" onclick="toggleMinimize()" title="Maximize">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 7H9V2H7V7H2V9H7V14H9V9H14V7Z" fill="#666"/>
        </svg>
      </button>
    </div>

    <div class="main-content">
      <div class="container">
        <div class="tab-navigation">
          <button id="tracking-button" class="tab-button active">Tracking</button>
          <button id="summary-button" class="tab-button">Summary</button>
          <button id="settings-button" class="tab-button">Settings</button>
        </div>

        <div id="tracking-tab" class="tab-content active">
          <div class="status-display">
            <div class="file-info">
              <div id="file-name">No file selected</div>
              <div id="page-name">No page selected</div>
            </div>
            <div class="timer-display" id="timer">0h 0m</div>
          </div>
          <div class="button-container">
            <button id="start-button" class="start-button">Start Tracking</button>
            <button id="stop-button" class="stop-button" style="display: none;">Stop Tracking</button>
          </div>
        </div>

        <div id="summary-tab" class="tab-content">
          <div class="summary-header">
            <h3 style="margin: 0;">Time Summary</h3>
          </div>
          <div class="summary-content" id="summary-content"></div>
        </div>

        <div id="settings-tab" class="tab-content">
          <div class="setting-item">
            <span class="setting-label">Background Tracking</span>
            <label class="switch">
              <input type="checkbox" id="background-tracking" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let isTracking = false;
    let trackingStartTime = 0;
    let timerInterval;
    let isMinimized = false;

    // Format duration in seconds to "Xh Ym Zs" format
    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours}h ${minutes}m ${secs}s`;
    }

    // Truncate string with ellipsis if too long
    function truncateString(str, maxLength) {
      if (str.length <= maxLength) return str;
      return str.substring(0, maxLength - 3) + '...';
    }

    // Save active tab preference
    function saveTabPreference(tabId) {
      figma.clientStorage.setAsync('activeTab', tabId);
    }

    // Load active tab preference
    async function loadTabPreference() {
      try {
        const savedTab = await figma.clientStorage.getAsync('activeTab');
        return savedTab || 'tracking-tab';
      } catch (error) {
        console.error('Error loading tab preference:', error);
        return 'tracking-tab';
      }
    }

    // Set up tab buttons
    function setupTabButtons() {
      const tabs = ['tracking', 'summary', 'settings'];
      
      tabs.forEach(tab => {
        const button = document.getElementById(`${tab}-button`);
        const content = document.getElementById(`${tab}-tab`);
        
        button.onclick = () => {
          // Remove active class from all buttons and contents
          tabs.forEach(t => {
            document.getElementById(`${t}-button`).classList.remove('active');
            document.getElementById(`${t}-tab`).classList.remove('active');
          });
          
          // Add active class to clicked button and its content
          button.classList.add('active');
          content.classList.add('active');
          
          // Save preference
          saveTabPreference(`${tab}-tab`);
          
          // If summary tab is selected, load the data
          if (tab === 'summary') {
            parent.postMessage({ pluginMessage: { type: 'get-summary' } }, '*');
          }
        };
      });
      
      // Load saved preference
      loadTabPreference().then(savedTab => {
        const tabName = savedTab.replace('-tab', '');
        document.getElementById(`${tabName}-button`).click();
      });
    }

    // Update timer display
    function updateTimer() {
      if (!isTracking) return;
      
      const now = Date.now();
      const elapsed = Math.floor((now - trackingStartTime) / 1000);
      document.getElementById('timer').textContent = formatDuration(elapsed);
    }

    // Start tracking
    function startTracking() {
      isTracking = true;
      trackingStartTime = Date.now();
      
      document.getElementById('start-button').style.display = 'none';
      document.getElementById('stop-button').style.display = 'block';
      
      timerInterval = setInterval(updateTimer, 1000);
      parent.postMessage({ pluginMessage: { type: 'start-tracking' } }, '*');
    }

    // Stop tracking
    function stopTracking() {
      isTracking = false;
      clearInterval(timerInterval);
      
      document.getElementById('start-button').style.display = 'block';
      document.getElementById('stop-button').style.display = 'none';
      
      document.getElementById('timer').textContent = '0h 0m';
      parent.postMessage({ pluginMessage: { type: 'stop-tracking' } }, '*');
    }

    // Update summary display
    function updateSummaryDisplay(summaryData) {
      const container = document.getElementById('summary-content');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!summaryData || Object.keys(summaryData).length === 0) {
        container.innerHTML = '<div class="file-summary">No tracking data available</div>';
        return;
      }

      // Calculate today's total time (6 AM to 6 AM)
      const now = new Date();
      const todayStart = new Date(now);
      todayStart.setHours(6, 0, 0, 0);
      if (now.getHours() < 6) {
        todayStart.setDate(todayStart.getDate() - 1);
      }

      let todayTotal = 0;
      const allPages = [];

      // Collect all pages and calculate today's total
      Object.values(summaryData).forEach(file => {
        if (!file.pages) return;
        
        Object.values(file.pages).forEach(page => {
          if (page && page.lastUpdated && page.totalTime > 0) {
            if (page.lastUpdated >= todayStart.getTime()) {
              todayTotal += page.totalTime;
            }
            allPages.push(page);
          }
        });
      });

      // Create today's total header
      const totalHeader = document.createElement('div');
      totalHeader.className = 'today-total';
      totalHeader.style.fontSize = '16px';
      totalHeader.style.fontWeight = '500';
      totalHeader.style.marginBottom = '16px';
      totalHeader.style.padding = '12px';
      totalHeader.style.backgroundColor = '#f0f7ff';
      totalHeader.style.borderRadius = '6px';
      totalHeader.style.color = '#18A0FB';
      totalHeader.textContent = `Today Total: ${formatDuration(Math.floor(todayTotal / 1000))}`;
      container.appendChild(totalHeader);

      // Sort all pages by total time
      const sortedPages = allPages
        .sort((a, b) => b.totalTime - a.totalTime);

      // Create pages list
      const pagesContainer = document.createElement('div');
      pagesContainer.className = 'pages-list';
      pagesContainer.style.display = 'flex';
      pagesContainer.style.flexDirection = 'column';
      pagesContainer.style.gap = '8px';

      sortedPages.forEach(page => {
        const pageElement = document.createElement('div');
        pageElement.className = 'page-summary';
        pageElement.style.display = 'flex';
        pageElement.style.justifyContent = 'space-between';
        pageElement.style.alignItems = 'center';
        pageElement.style.padding = '8px 12px';
        pageElement.style.backgroundColor = '#f5f5f5';
        pageElement.style.borderRadius = '4px';
        pageElement.style.fontSize = '14px';

        const pageName = document.createElement('div');
        pageName.style.flex = '1';
        pageName.style.fontWeight = '500';
        pageName.textContent = truncateString(page.name, 25);

        const pageTime = document.createElement('div');
        pageTime.style.marginLeft = '12px';
        pageTime.style.color = '#666';
        pageTime.textContent = formatDuration(Math.floor(page.totalTime / 1000));

        // Add highlight for today's pages
        if (page.lastUpdated >= todayStart.getTime()) {
          pageElement.style.backgroundColor = '#f8f8f8';
          pageElement.style.borderLeft = '3px solid #18A0FB';
        }

        pageElement.appendChild(pageName);
        pageElement.appendChild(pageTime);
        pagesContainer.appendChild(pageElement);
      });

      container.appendChild(pagesContainer);
      container.style.overflowY = 'auto';
    }

    // Set up event listeners
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'tracking-status') {
        isTracking = msg.isTracking;
        
        if (msg.fileName) {
          document.getElementById('file-name').textContent = truncateString(msg.fileName, 30);
        }
        if (msg.pageName) {
          document.getElementById('page-name').textContent = truncateString(msg.pageName, 30);
        }
        
        if (isTracking) {
          trackingStartTime = msg.startTime;
          document.getElementById('start-button').style.display = 'none';
          document.getElementById('stop-button').style.display = 'block';
          if (!timerInterval) {
            timerInterval = setInterval(updateTimer, 1000);
          }
        } else {
          document.getElementById('start-button').style.display = 'block';
          document.getElementById('stop-button').style.display = 'none';
          clearInterval(timerInterval);
          timerInterval = null;
          document.getElementById('timer').textContent = '0h 0m';
        }
      }
      else if (msg.type === 'summary-data') {
        updateSummaryDisplay(msg.data);
      }
      else if (msg.type === 'file-changed') {
        document.getElementById('file-name').textContent = truncateString(msg.fileName, 30);
        document.getElementById('page-name').textContent = truncateString(msg.pageName, 30);
        
        if (msg.resetTimer) {
          document.getElementById('timer').textContent = '0h 0m';
        }
      }
    };

    // Initialize UI
    document.getElementById('start-button').onclick = startTracking;
    document.getElementById('stop-button').onclick = stopTracking;
    document.getElementById('background-tracking').onchange = (e) => {
      parent.postMessage({
        pluginMessage: {
          type: 'toggle-background-tracking',
          enabled: e.target.checked
        }
      }, '*');
    };

    // Set up tabs
    setupTabButtons();

    // Tell the plugin we're ready
    parent.postMessage({ pluginMessage: { type: 'ui-loaded' } }, '*');

    function toggleMinimize() {
      const container = document.querySelector('.plugin-container');
      const minimizedView = document.querySelector('.minimized-view');
      const mainContent = document.querySelector('.main-content');
      const topBar = document.querySelector('.top-bar');
      
      isMinimized = !isMinimized;
      
      if (isMinimized) {
        container.classList.add('minimized');
        minimizedView.classList.add('visible');
        mainContent.style.display = 'none';
        topBar.style.display = 'none';
        
        // Update minimized view with current page
        const pageName = document.getElementById('page-name').textContent;
        document.getElementById('minimized-page').textContent = pageName;
        
        // Notify the plugin code about the size change
        parent.postMessage({ pluginMessage: { type: 'resize', height: 32 } }, '*');
      } else {
        container.classList.remove('minimized');
        minimizedView.classList.remove('visible');
        mainContent.style.display = 'block';
        topBar.style.display = 'flex';
        
        // Restore original size
        parent.postMessage({ pluginMessage: { type: 'resize', height: 400 } }, '*');
      }
    }

    // Update minimized view info
    function updateMinimizedView(pageName, time) {
      const minimizedPage = document.getElementById('minimized-page');
      const minimizedTime = document.getElementById('minimized-time');
      
      if (minimizedPage && minimizedTime) {
        minimizedPage.textContent = pageName || 'No active page';
        minimizedTime.textContent = time || '0h 0m 0s';
      }
    }

    // Modify your existing timer update function to also update minimized view
    function updateTimer(seconds) {
      const timerDisplay = document.getElementById('timer');
      const formattedTime = formatDuration(seconds);
      
      if (timerDisplay) {
        timerDisplay.textContent = formattedTime;
      }
      
      // Update minimized view
      const pageName = document.getElementById('page-name').textContent;
      document.getElementById('minimized-page').textContent = pageName;
    }
  </script>
</body>
</html>


