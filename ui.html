<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      color: #333;
      background: #fff;
      height: 368px; /* 400px - 32px padding */
      box-sizing: border-box;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tab-navigation {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 8px;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 8px 16px;
      margin-right: 8px;
      cursor: pointer;
      color: #666;
      font-weight: 500;
      border-radius: 4px;
    }

    .tab-button.active {
      background: #18A0FB;
      color: white;
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* Tracking Tab */
    #tracking-tab {
      gap: 16px;
    }

    .status-display {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .timer-display {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 16px 0;
    }

    .button-container {
      display: flex;
      gap: 8px;
    }

    button {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .start-button {
      background: #18A0FB;
      color: white;
    }

    .stop-button {
      background: #EB4D4D;
      color: white;
    }

    /* Summary Tab */
    #summary-tab {
      gap: 12px;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .summary-content {
      flex: 1;
      overflow: hidden;
    }

    .file-summary {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-summary:last-child {
      margin-bottom: 0;
    }

    .file-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .file-time {
      color: #666;
      font-size: 14px;
    }

    /* Settings Tab */
    #settings-tab {
      gap: 16px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .setting-label {
      font-size: 14px;
      color: #333;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #18A0FB;
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tab-navigation">
      <button id="tracking-button" class="tab-button active">Tracking</button>
      <button id="summary-button" class="tab-button">Summary</button>
      <button id="settings-button" class="tab-button">Settings</button>
    </div>

    <div id="tracking-tab" class="tab-content active">
      <div class="status-display">
        <div class="file-info">
          <div id="file-name">No file selected</div>
          <div id="page-name">No page selected</div>
        </div>
        <div class="timer-display" id="timer">0h 0m</div>
      </div>
      <div class="button-container">
        <button id="start-button" class="start-button">Start Tracking</button>
        <button id="stop-button" class="stop-button" style="display: none;">Stop Tracking</button>
      </div>
    </div>

    <div id="summary-tab" class="tab-content">
      <div class="summary-header">
        <h3 style="margin: 0;">Time Summary</h3>
      </div>
      <div class="summary-content" id="summary-content"></div>
    </div>

    <div id="settings-tab" class="tab-content">
      <div class="setting-item">
        <span class="setting-label">Background Tracking</span>
        <label class="switch">
          <input type="checkbox" id="background-tracking" checked>
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

<script>
    let isTracking = false;
    let trackingStartTime = 0;
    let timerInterval;

    // Format duration in seconds to "Xh Ym Zs" format
    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours}h ${minutes}m ${secs}s`;
    }

    // Truncate string with ellipsis if too long
    function truncateString(str, maxLength) {
      if (str.length <= maxLength) return str;
      return str.substring(0, maxLength - 3) + '...';
    }

    // Save active tab preference
    function saveTabPreference(tabId) {
      figma.clientStorage.setAsync('activeTab', tabId);
    }

    // Load active tab preference
    async function loadTabPreference() {
      try {
        const savedTab = await figma.clientStorage.getAsync('activeTab');
        return savedTab || 'tracking-tab';
      } catch (error) {
        console.error('Error loading tab preference:', error);
        return 'tracking-tab';
      }
    }

    // Set up tab buttons
    function setupTabButtons() {
      const tabs = ['tracking', 'summary', 'settings'];
      
      tabs.forEach(tab => {
        const button = document.getElementById(`${tab}-button`);
        const content = document.getElementById(`${tab}-tab`);
        
        button.onclick = () => {
          // Remove active class from all buttons and contents
          tabs.forEach(t => {
            document.getElementById(`${t}-button`).classList.remove('active');
            document.getElementById(`${t}-tab`).classList.remove('active');
          });
          
          // Add active class to clicked button and its content
          button.classList.add('active');
          content.classList.add('active');
          
          // Save preference
          saveTabPreference(`${tab}-tab`);
          
          // If summary tab is selected, load the data
          if (tab === 'summary') {
            parent.postMessage({ pluginMessage: { type: 'get-summary' } }, '*');
          }
        };
      });
      
      // Load saved preference
      loadTabPreference().then(savedTab => {
        const tabName = savedTab.replace('-tab', '');
        document.getElementById(`${tabName}-button`).click();
      });
    }

    // Update timer display
    function updateTimer() {
      if (!isTracking) return;
      
      const now = Date.now();
      const elapsed = Math.floor((now - trackingStartTime) / 1000);
      document.getElementById('timer').textContent = formatDuration(elapsed);
    }

    // Start tracking
    function startTracking() {
      isTracking = true;
      trackingStartTime = Date.now();
      
      document.getElementById('start-button').style.display = 'none';
      document.getElementById('stop-button').style.display = 'block';
      
      timerInterval = setInterval(updateTimer, 1000);
      parent.postMessage({ pluginMessage: { type: 'start-tracking' } }, '*');
    }

    // Stop tracking
    function stopTracking() {
      isTracking = false;
      clearInterval(timerInterval);
      
      document.getElementById('start-button').style.display = 'block';
      document.getElementById('stop-button').style.display = 'none';
      
      document.getElementById('timer').textContent = '0h 0m';
      parent.postMessage({ pluginMessage: { type: 'stop-tracking' } }, '*');
    }

    // Update summary display
    function updateSummaryDisplay(summaryData) {
      const container = document.getElementById('summary-content');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!summaryData || Object.keys(summaryData).length === 0) {
        container.innerHTML = '<div class="file-summary">No tracking data available</div>';
        return;
      }
      
      console.log('Processing files for display:', Object.keys(summaryData));
      
      // Sort files by total time (descending)
      const sortedFiles = Object.entries(summaryData)
        .filter(([_, file]) => file && file.totalTime > 0)
        .sort(([_, a], [_, b]) => (b.totalTime || 0) - (a.totalTime || 0))
        .map(([fileId, file]) => ({...file, fileId}));
      
      console.log('Sorted files:', sortedFiles.map(f => f.name));
      
      sortedFiles.forEach(file => {
        const fileElement = document.createElement('div');
        fileElement.className = 'file-summary';
        fileElement.style.marginBottom = '16px';
        fileElement.style.background = '#f8f8f8';
        fileElement.style.borderRadius = '8px';
        fileElement.style.overflow = 'hidden';
        
        // File header
        const fileHeader = document.createElement('div');
        fileHeader.className = 'file-header';
        fileHeader.style.display = 'flex';
        fileHeader.style.justifyContent = 'space-between';
        fileHeader.style.alignItems = 'center';
        fileHeader.style.padding = '12px 16px';
        fileHeader.style.background = '#e8e8e8';
        fileHeader.style.borderBottom = '1px solid #ddd';
        
        const nameElement = document.createElement('div');
        nameElement.className = 'file-name';
        nameElement.style.flex = '1';
        nameElement.style.fontWeight = '600';
        nameElement.style.fontSize = '14px';
        nameElement.textContent = truncateString(file.name, 35);
        
        const timeElement = document.createElement('div');
        timeElement.className = 'file-time';
        timeElement.style.marginLeft = '12px';
        timeElement.style.color = '#666';
        timeElement.style.fontWeight = '500';
        timeElement.textContent = formatDuration(Math.floor(file.totalTime / 1000));
        
        fileHeader.appendChild(nameElement);
        fileHeader.appendChild(timeElement);
        fileElement.appendChild(fileHeader);
        
        // Pages container
        if (file.pages && Object.keys(file.pages).length > 0) {
          const pagesContainer = document.createElement('div');
          pagesContainer.className = 'pages-container';
          pagesContainer.style.padding = '8px 16px';
          
          // Filter and sort pages for this file
          const sortedPages = Object.entries(file.pages)
            .filter(([pageKey, page]) => {
              return page && 
                     page.totalTime > 0 && 
                     pageKey.startsWith(file.fileId);
            })
            .sort(([_, a], [_, b]) => (b.totalTime || 0) - (a.totalTime || 0))
            .map(([_, page]) => page);
          
          console.log(`Pages for ${file.name}:`, sortedPages.map(p => p.name));
          
          if (sortedPages.length > 0) {
            sortedPages.forEach(page => {
              const pageElement = document.createElement('div');
              pageElement.className = 'page-summary';
              pageElement.style.display = 'flex';
              pageElement.style.justifyContent = 'space-between';
              pageElement.style.alignItems = 'center';
              pageElement.style.padding = '8px 12px';
              pageElement.style.margin = '4px 0';
              pageElement.style.background = 'white';
              pageElement.style.borderRadius = '4px';
              pageElement.style.border = '1px solid #eee';
              
              const pageName = document.createElement('div');
              pageName.style.flex = '1';
              pageName.style.fontSize = '13px';
              pageName.style.color = '#444';
              pageName.textContent = truncateString(page.name, 30);
              
              const pageTime = document.createElement('div');
              pageTime.style.marginLeft = '12px';
              pageTime.style.fontSize = '13px';
              pageTime.style.color = '#666';
              pageTime.textContent = formatDuration(Math.floor(page.totalTime / 1000));
              
              pageElement.appendChild(pageName);
              pageElement.appendChild(pageTime);
              pagesContainer.appendChild(pageElement);
            });
            
            fileElement.appendChild(pagesContainer);
          }
        }
        
        container.appendChild(fileElement);
      });
      
      // Enable smooth scrolling
      container.style.overflowY = 'auto';
      container.style.scrollBehavior = 'smooth';
    }

    // Set up event listeners
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'tracking-status') {
        isTracking = msg.isTracking;
        
        if (msg.fileName) {
          document.getElementById('file-name').textContent = truncateString(msg.fileName, 30);
        }
        if (msg.pageName) {
          document.getElementById('page-name').textContent = truncateString(msg.pageName, 30);
        }
        
        if (isTracking) {
          trackingStartTime = msg.startTime;
          document.getElementById('start-button').style.display = 'none';
          document.getElementById('stop-button').style.display = 'block';
          if (!timerInterval) {
            timerInterval = setInterval(updateTimer, 1000);
          }
        } else {
          document.getElementById('start-button').style.display = 'block';
          document.getElementById('stop-button').style.display = 'none';
          clearInterval(timerInterval);
          timerInterval = null;
          document.getElementById('timer').textContent = '0h 0m';
        }
      }
      else if (msg.type === 'summary-data') {
        updateSummaryDisplay(msg.data);
      }
      else if (msg.type === 'file-changed') {
        document.getElementById('file-name').textContent = truncateString(msg.fileName, 30);
        document.getElementById('page-name').textContent = truncateString(msg.pageName, 30);
        
        if (msg.resetTimer) {
          document.getElementById('timer').textContent = '0h 0m';
        }
      }
    };

    // Initialize UI
    document.getElementById('start-button').onclick = startTracking;
    document.getElementById('stop-button').onclick = stopTracking;
    document.getElementById('background-tracking').onchange = (e) => {
      parent.postMessage({
        pluginMessage: {
          type: 'toggle-background-tracking',
          enabled: e.target.checked
        }
      }, '*');
    };

    // Set up tabs
    setupTabButtons();

    // Tell the plugin we're ready
    parent.postMessage({ pluginMessage: { type: 'ui-loaded' } }, '*');
</script>
</body>
</html>


