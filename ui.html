<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Figma Time Tracker</title>
  <script src="localStorage-fix.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fff;
      color: #333;
    }
    
    .container {
      padding: 16px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 16px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 16px;
    }
    
    .tab-button {
      padding: 8px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: 500;
      color: #666;
    }
    
    .tab-button.active {
      color: #000;
      border-bottom: 2px solid #000;
    }
    
    .tab-content {
      display: none;
      margin-top: 16px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Timer */
    .timer-section {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .timer-display {
      font-size: 36px;
      font-weight: bold;
      margin: 16px 0;
      position: relative;
      display: inline-block;
    }
    
    #timer-dot {
      position: absolute;
      top: 0;
      right: -12px;
      width: 8px;
      height: 8px;
      background-color: #ff3b30;
      border-radius: 50%;
      display: none;
    }
    
    /* Timer dot animation */
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    #timer-dot.pulsing {
      animation: pulse 1.5s infinite ease-in-out;
    }
    
    /* Status text styles */
    #status-text {
      text-align: center;
      margin: 8px 0;
      font-size: 14px;
      font-weight: 500;
    }
    
    .status-active {
      color: #34c759;
    }
    
    .status-inactive {
      color: #8e8e93;
    }
    
    /* Timer container */
    .timer-container {
      position: relative;
      display: inline-block;
    }
    
    /* Timer indicator */
    .timer-indicator {
      position: absolute;
      top: 4px;
      right: -12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .timer-indicator.active {
      background-color: #34c759;
    }
    
    .timer-indicator.inactive {
      background-color: #8e8e93;
    }
    
    .file-info {
      margin-bottom: 16px;
      text-align: center;
    }
    
    #file-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    #page-name {
      color: #666;
      font-size: 14px;
    }
    
    /* Buttons */
    .control-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    #start-button {
      background-color: #34c759;
      color: white;
    }
    
    #stop-button {
      background-color: #ff3b30;
      color: white;
      display: none;
    }
    
    /* Settings */
    .settings-section {
      margin-bottom: 24px;
    }
    
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    
    .setting-label {
      font-weight: 500;
    }
    
    /* Files list */
    .files-list {
      margin-top: 24px;
    }
    
    .file-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    
    .file-item-name {
      font-weight: 500;
    }
    
    .file-item-time {
      color: #666;
    }
    
    /* Summary tab */
    #summary-tab {
      position: relative;
    }
    
    #summary-loading {
      text-align: center;
      margin: 20px 0;
      color: #666;
      font-style: italic;
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .summary-refresh button {
      background-color: #007aff;
      color: white;
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .summary-list {
      margin-bottom: 24px;
    }
    
    .summary-file-entry {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .summary-file-name {
      font-weight: 500;
    }
    
    .summary-file-time {
      font-family: monospace;
    }
    
    .summary-total {
      display: flex;
      justify-content: space-between;
      padding: 16px 0;
      border-top: 2px solid #ddd;
      margin-top: 8px;
    }
    
    .summary-total-label {
      font-weight: bold;
    }
    
    .summary-total-time {
      font-family: monospace;
      font-weight: bold;
    }
    
    .no-data {
      text-align: center;
      color: #666;
      margin: 40px 0;
    }
    
    .error {
      color: #ff3b30;
      text-align: center;
      margin: 20px 0;
    }
    
    .summary-retry-button, .summary-refresh-button {
      display: block;
      margin: 16px auto;
      background-color: #007aff;
      color: white;
    }
    
    /* Firebase status */
    #firebase-status {
      text-align: center;
      font-size: 12px;
      margin-top: 20px;
      min-height: 16px;
    }
    
    /* Toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #2196F3;
    }
    
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* Error message */
    .error-message {
      background-color: #fff8f8;
      border-left: 4px solid #ff3b30;
      color: #333;
      padding: 12px;
      margin: 16px 0;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .warning-message {
      background-color: #fffbf0;
      border-left: 4px solid #ffcc00;
      color: #333;
      padding: 12px;
      margin: 16px 0;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .message-title {
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .message-action {
      margin-top: 8px;
    }
    
    .message-action button {
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-left: 8px;
    }
    
    .status-indicator.good {
      background-color: #34c759;
    }
    
    .status-indicator.warning {
      background-color: #ffcc00;
    }
    
    .status-indicator.error {
      background-color: #ff3b30;
    }
    
    .storage-status-container {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    
    #storage-info {
      margin-top: 8px;
      margin-bottom: 16px;
      font-size: 12px;
      color: #666;
    }
    
    #storage-actions {
      margin-top: 12px;
    }
    
    .danger-button {
      background-color: #ff3b30;
      color: white;
      font-size: 12px;
      padding: 6px 12px;
    }
    
    .firebase-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 6px;
    }
    
    .firebase-indicator.connected {
      background-color: #34c759;
    }
    
    .firebase-indicator.connecting {
      background-color: #ffcc00;
      animation: pulse 1.5s infinite;
    }
    
    .firebase-indicator.disconnected {
      background-color: #ff3b30;
    }
    
    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    .data-source-indicator {
      font-size: 11px;
      color: #888;
      margin-top: 16px;
      text-align: center;
      padding: 4px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }

    .firebase-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #18A0FB;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Data source indicator styles */
    .data-source {
      font-size: 12px;
      color: #999;
      display: block;
      margin-top: 4px;
    }
    
    .summary-header {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }
    
    .summary-header h3 {
      margin: 0;
    }

    /* CSS for Firebase indicators */
    .firebase-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 6px;
    }
    
    .firebase-indicator.connected {
      background-color: #4CAF50;  /* Green */
    }
    
    .firebase-indicator.disconnected {
      background-color: #F44336;  /* Red */
    }
    
    .firebase-indicator.connecting {
      background-color: #FFC107;  /* Amber */
    }
    
    .firebase-indicator.initializing {
      background-color: #2196F3;  /* Blue */
    }
    
    #firebase-status-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 4px 8px;
      font-size: 11px;
      color: #999;
      text-align: center;
      background-color: #f5f5f5;
      border-top: 1px solid #eee;
      display: none;  /* Hidden by default, show when needed */
    }

    /* CSS for error display */
    .error-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }
    
    .error-icon {
      font-size: 28px;
      margin-bottom: 12px;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }
    
    .empty-icon {
      font-size: 28px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation Tabs -->
    <div class="tab-buttons">
      <button class="tab-button active" data-tab="tracking-tab" onclick="handleTabButtonClick('tracking-tab')">Tracking</button>
      <button class="tab-button" data-tab="summary-tab" onclick="handleTabButtonClick('summary-tab')">Summary</button>
      <button class="tab-button" data-tab="settings-tab" onclick="handleTabButtonClick('settings-tab')">Settings</button>
    </div>
    
    <!-- Tracking Tab -->
    <div id="tracking-tab" class="tab-content active">
      <!-- Timer Display -->
      <div class="timer-section">
        <div class="timer-display">
          <span id="timer">00:00:00</span>
          <div id="timer-dot"></div>
        </div>
        <div id="status-text" class="status-inactive">Not tracking</div>
      </div>
      
      <!-- File Info -->
      <div class="file-info">
        <div id="file-name">No file selected</div>
        <div id="page-name"></div>
      </div>
      
      <!-- Control Buttons -->
      <div class="control-buttons">
        <button id="start-button">Start Tracking</button>
        <button id="stop-button">Stop Tracking</button>
      </div>
      
      <!-- Files List -->
      <div class="files-list" id="files-list">
        <!-- Files will be added here dynamically -->
      </div>
    </div>
    
    <!-- Summary Tab -->
    <div id="summary-tab" class="tab-content">
      <div id="summary-loading"></div>
      <div id="summary-container">
        <!-- Summary data will be loaded here -->
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="settings-section">
        <div class="setting-item">
          <div class="setting-label">Background Tracking</div>
          <label class="switch">
            <input type="checkbox" id="background-tracking" checked>
            <span class="slider"></span>
          </label>
        </div>
        <p class="setting-description">
          When enabled, tracking continues even when switching between files.
        </p>
        
        <div class="setting-item">
          <div class="setting-label">Firebase Sync</div>
          <div>
            <button id="sync-to-firebase">Save to Firebase</button>
            <button id="sync-from-firebase">Load from Firebase</button>
            <span id="firebase-connection-status" class="firebase-indicator disconnected" title="Firebase disconnected"></span>
          </div>
        </div>
        
        <div id="firebase-status"></div>
        
        <!-- Storage Status Section -->
        <div class="setting-item storage-status-container">
          <div class="setting-label">Local Storage Status</div>
          <div id="storage-status-indicator" class="status-indicator"></div>
        </div>
        
        <div id="storage-info">
          <div id="storage-usage"></div>
          <div id="storage-actions">
            <button id="clear-storage" class="danger-button">Clear Local Storage</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // Firebase variables
    let firebaseConfig = null;
    let firebaseInitialized = false;
    let firebaseApp = null;
    let firebaseDb = null;
    let userId = null;
    let files = {};
    let activeFileId = null;
    let activePage = null;
    let isTracking = false;
    let timerInterval = null;
    let startTime = null;
    let updateTimerInterval = null;
    let summaryLoaded = false;
    let activeFileName = null;
    let activePageName = null;
    let backgroundTracking = true;
    let summaryData = null;
    let lastSavedTimestamp = 0;
    let trackingData = {};
    let inMemoryCache = {}; // Fallback cache when localStorage fails
    let firebaseConnected = false;
    let connectionRef = null;
    let currentSessionId = null;
    let activelyFetchingFromFirebase = false;
    let activelyInitializingFirebase = false;
    let firebaseInitRetryCount = 0;
    const MAX_FIREBASE_INIT_RETRIES = 3;
    let firebaseInitTimeoutId = null;

    // Initialize Firebase when config is received
    function initializeFirebase(config) {
      // Prevent multiple simultaneous initialization attempts
      if (activelyInitializingFirebase) {
        console.log('Firebase initialization already in progress, ignoring duplicate request');
        return;
      }
      
      // Reset Firebase state if we're retrying
      firebaseInitialized = false;
      clearTimeout(firebaseInitTimeoutId);
      
      try {
        console.log('Initializing Firebase with config:', config);
        firebaseConfig = config;
        
        // Mark as actively initializing to prevent race conditions
        activelyInitializingFirebase = true;
        
        // Update UI to show we're connecting
        updateFirebaseStatus('Connecting to Firebase...');
        
        // Global timeout for the entire initialization process
        firebaseInitTimeoutId = setTimeout(() => {
          if (!firebaseInitialized) {
            console.warn(`Firebase initialization timed out after 15 seconds (attempt ${firebaseInitRetryCount + 1}/${MAX_FIREBASE_INIT_RETRIES})`);
            if (firebaseInitRetryCount < MAX_FIREBASE_INIT_RETRIES) {
              firebaseInitRetryCount++;
              activelyInitializingFirebase = false;
              initializeFirebase(config); // Retry initialization
            } else {
              console.error('Max Firebase initialization retries reached, falling back to local storage');
              handleFirebaseError(new Error('Firebase initialization timed out after multiple attempts'));
              proceedWithoutAuth();
            }
          }
        }, 15000);
        
        // Initialize Firebase app if not already initialized
        if (firebase.apps.length) {
          try {
            // Try to delete existing app if there's an issue
            firebase.app().delete().then(() => {
              console.log('Previous Firebase app deleted');
              firebaseApp = firebase.initializeApp(firebaseConfig);
              continueFirebaseInit();
            }).catch(error => {
              console.warn('Error deleting previous Firebase app:', error);
              firebaseApp = firebase.app();
              continueFirebaseInit();
            });
          } catch (e) {
            console.warn('Error handling existing Firebase app:', e);
            firebaseApp = firebase.app();
            continueFirebaseInit();
          }
        } else {
          firebaseApp = firebase.initializeApp(firebaseConfig);
          continueFirebaseInit();
        }
      } catch (error) {
        console.error('Error initializing Firebase:', error);
        handleFirebaseError(error);
        clearTimeout(firebaseInitTimeoutId);
        activelyInitializingFirebase = false;
        proceedWithoutAuth();
      }
    }
    
    // Continue Firebase initialization after app setup
    function continueFirebaseInit() {
      try {
        firebaseDb = firebase.database();
        
        // Monitor Firebase connection status
        setupFirebaseConnectionMonitor();
        
        // Enable Firebase persistence if possible
        try {
          firebase.database().goOnline();
          updateFirebaseConnectionStatus('connecting');
          console.log('Firebase connection online');
        } catch (persistError) {
          console.warn('Could not enable Firebase persistence:', persistError);
          updateFirebaseConnectionStatus('disconnected');
        }
        
        // Set up anonymous authentication with timeout
        let authTimeoutId = setTimeout(() => {
          console.warn('Firebase auth timed out, proceeding with fallback methods');
          proceedWithoutAuth();
        }, 7000);
        
        firebase.auth().onAuthStateChanged((user) => {
          // Clear the timeout since auth state changed
          clearTimeout(authTimeoutId);
          
          if (user) {
            console.log('Firebase auth state changed: user signed in', user.uid);
            completeFirebaseInit(user.uid);
          } else {
            console.log('Firebase auth state changed: no user signed in');
            // User is signed out, sign in anonymously
            firebase.auth().signInAnonymously()
              .then(() => {
                console.log('Signed in anonymously to Firebase');
              })
              .catch((error) => {
                console.error('Error signing in anonymously:', error);
                handleFirebaseError(error);
                proceedWithoutAuth();
              });
          }
        });
      } catch (error) {
        console.error('Error in continueFirebaseInit:', error);
        handleFirebaseError(error);
        activelyInitializingFirebase = false;
        clearTimeout(firebaseInitTimeoutId);
        proceedWithoutAuth();
      }
    }
    
    // Complete Firebase initialization after auth
    function completeFirebaseInit(uid) {
      // Clear the global initialization timeout
      clearTimeout(firebaseInitTimeoutId);
      
      // User is signed in - ensure we have a string uid
      userId = uid ? String(uid) : generateUniqueId();
      
      console.log('Firebase initialized with user ID:', userId);
      firebaseInitialized = true;
      
      // Reset retry counter since we succeeded
      firebaseInitRetryCount = 0;
      
      // Store userId in localStorage for persistence
      try {
        localStorage.setItem('figmaTimeTrackUserId', userId);
      } catch (e) {
        console.warn('Failed to store userId in localStorage:', e);
      }
      
      // Record this session in Firebase
      recordSessionStart();
      
      // Notify plugin that Firebase is initialized
      parent.postMessage({ 
        pluginMessage: { 
          type: 'firebase-init-complete', 
          userId: userId 
        } 
      }, '*');
      
      // Set up real-time listener for tracking data
      setupFirebaseDataListener();
      
      // Immediately check if we need to start a new day's tracking
      checkAndHandleDayChange();
      
      // Immediately load summary data if on summary tab
      if (document.getElementById('summary-tab').classList.contains('active')) {
        loadSummaryFromFirebase();
      } else {
        // Load summary data in the background to have it ready
        setTimeout(() => {
          loadSummaryFromFirebase(false); // Silent load
        }, 2000);
      }
      
      // Update UI to show connected status
      updateFirebaseStatus('Connected to Firebase');
      
      // Clear active initialization flag
      activelyInitializingFirebase = false;
    }
    
    // Proceed with initialization even without auth
    function proceedWithoutAuth() {
      // Clear the global initialization timeout
      clearTimeout(firebaseInitTimeoutId);
      
      console.log('Proceeding with initialization without auth');
      
      // First try to get userId from localStorage
      if (!userId) {
        try {
          const storedUserId = localStorage.getItem('figmaTimeTrackUserId');
          if (storedUserId) {
            userId = storedUserId;
            console.log('Retrieved userId from localStorage:', userId);
          }
        } catch (e) {
          console.warn('Failed to retrieve userId from localStorage:', e);
        }
      }
      
      // If we still don't have a userId, generate one
      if (!userId) {
        userId = generateUniqueId();
        console.log('Generated new userId:', userId);
        
        // Store the new userId
        try {
          localStorage.setItem('figmaTimeTrackUserId', userId);
        } catch (e) {
          console.warn('Failed to store userId in localStorage:', e);
        }
      }
      
      // Ensure userId is a string
      userId = String(userId);
      console.log('Using userId:', userId);
      
      // Set up real-time listener for tracking data
      setupFirebaseDataListener();
      
      // Notify the plugin of our userId
      parent.postMessage({ 
        pluginMessage: { 
          type: 'firebase-init-complete', 
          userId: userId 
        } 
      }, '*');
      
      // Immediately load summary data if on summary tab
      if (document.getElementById('summary-tab').classList.contains('active')) {
        loadSummaryFromFirebase();
      }
      
      // Clear active initialization flag
      activelyInitializingFirebase = false;
    }
    
    // Record the start of a new plugin session
    function recordSessionStart() {
      if (!firebaseDb || !userId) return;
      
      try {
        const sessionId = generateUniqueId();
        const timestamp = Date.now();
        
        // Store the session start in Firebase
        firebaseDb.ref(`sessions/${userId}/${sessionId}`).set({
          startTime: timestamp,
          userAgent: navigator.userAgent,
          status: 'active'
        }).then(() => {
          console.log('Recorded session start in Firebase');
          
          // Store the session ID locally
          currentSessionId = sessionId;
          localStorage.setItem('figmaTimeTrackSessionId', sessionId);
          
          // Update the user's metadata
          return firebaseDb.ref(`metadata/${userId}`).update({
            lastSessionStart: timestamp,
            currentSessionId: sessionId
          });
        }).catch(error => {
          console.error('Error recording session start:', error);
        });
      } catch (error) {
        console.error('Error in recordSessionStart:', error);
      }
    }
    
    // Generate a unique ID for sessions
    function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    
    // Set up real-time listener for changes to Firebase data
    function setupFirebaseDataListener() {
      if (!firebaseDb || !userId) {
        console.warn('Firebase not initialized, cannot set up data listener');
        return;
      }
      
      try {
        console.log('Setting up Firebase real-time data listener');
        const dataRef = firebaseDb.ref('timeData/' + userId);
        
        // Detach any existing listeners
        dataRef.off();
        
        // Listen for value changes
        dataRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            console.log('Real-time update from Firebase received');
            
            // Update in-memory data
            summaryData = data;
            trackingData = { ...data }; // Clone data for tracking
            lastSavedTimestamp = Date.now();
            
            // Always use this data for the UI as it's the most authoritative
            if (document.getElementById('summary-tab').classList.contains('active')) {
              updateSummaryDisplay(data);
            }
            
            // Try to store a backup in localStorage
            try {
              localStorage.setItem('figmaTimeTrackSummary_backup', JSON.stringify(summaryData));
              localStorage.setItem('figmaTimeTrackSummaryTimestamp', Date.now().toString());
            } catch (e) {
              console.warn('Could not save Firebase data to localStorage backup:', e);
            }
            
            // Update UI with connection status
            updateFirebaseStatus('Data updated from Firebase');
          }
        }, (error) => {
          console.error('Firebase real-time listener error:', error);
          handleFirebaseError(error);
        });
        
      } catch (error) {
        console.error('Error setting up Firebase data listener:', error);
      }
    }
    
    // Handle Firebase errors gracefully
    function handleFirebaseError(error) {
      console.error('Firebase error:', error);
      
      // Update connection status
      updateFirebaseConnectionStatus('disconnected');
      
      // Notify the plugin about the error
      parent.postMessage({ 
        pluginMessage: { 
          type: 'firebase-error', 
          error: error.message || 'Unknown Firebase error'
        } 
      }, '*');
      
      // Show error in UI
      document.getElementById('firebase-status').textContent = 'Firebase Error: ' + (error.message || 'Unknown error');
      document.getElementById('firebase-status').style.color = 'red';
      
      // If we're on the summary tab, use local data immediately
      if (document.getElementById('summary-tab').classList.contains('active')) {
        // First try to use any cached data
        if (summaryData && Object.keys(summaryData).length > 0) {
          console.log('Using cached summary data due to Firebase error');
          updateSummaryDisplay(summaryData);
        } else {
          // Otherwise request local data
          requestLocalSummaryData();
        }
      }
    }
    
    // Check if we need to start a new day's tracking (8am to 8am cycle)
    function checkAndHandleDayChange() {
      if (!firebaseDb || !userId) return;
      
      try {
        // Get the last reset timestamp
        const lastResetRef = firebaseDb.ref('users/' + userId + '/lastReset');
        lastResetRef.once('value')
          .then(snapshot => {
            const lastReset = snapshot.val() || 0;
            const now = new Date();
            const currentTime = now.getTime();
            
            // Check if it's past 8am
            const todayEightAM = new Date(now);
            todayEightAM.setHours(8, 0, 0, 0);
            
            // If it's before 8am, we use yesterday's 8am as reference
            if (now.getHours() < 8) {
              todayEightAM.setDate(todayEightAM.getDate() - 1);
            }
            
            // Check if we haven't reset since the last 8am mark
            if (lastReset < todayEightAM.getTime()) {
              console.log('Day change detected (8am-8am cycle). Archiving previous day data...');
              
              // Archive previous day's data first
              archivePreviousDayData(lastReset, todayEightAM.getTime())
                .then(() => {
                  // Update the last reset timestamp
                  lastResetRef.set(currentTime);
                  console.log('Day change handled, reset timestamp updated');
                })
                .catch(error => {
                  console.error('Error handling day change:', error);
                });
            } else {
              console.log('No day change needed. Last reset:', new Date(lastReset).toLocaleString());
            }
          })
          .catch(error => {
            console.error('Error checking day change:', error);
          });
      } catch (error) {
        console.error('Error in checkAndHandleDayChange:', error);
      }
    }

    // Archive previous day's data for history
    function archivePreviousDayData(lastReset, currentReset) {
      return new Promise((resolve, reject) => {
        try {
          console.log('Archiving data from', new Date(lastReset).toLocaleString(), 'to', new Date(currentReset).toLocaleString());
          
          // Get the current data
          const currentDataRef = firebaseDb.ref('timeData/' + userId);
          currentDataRef.once('value')
            .then(snapshot => {
              const currentData = snapshot.val();
              
              if (!currentData) {
                console.log('No data to archive');
                resolve();
                return;
              }
              
              // Create an archive entry with timestamp
              const archiveRef = firebaseDb.ref('timeDataArchive/' + userId + '/' + currentReset);
              
              // Store the current data in the archive
              archiveRef.set({
                periodStart: lastReset || (currentReset - 86400000), // Default to 24 hours before if no last reset
                periodEnd: currentReset,
                data: currentData
              })
                .then(() => {
                  console.log('Previous day data archived successfully');
                  // We don't clear the data - we keep accumulating
                  resolve();
                })
                .catch(error => {
                  console.error('Error archiving data:', error);
                  reject(error);
                });
            })
            .catch(error => {
              console.error('Error getting current data for archiving:', error);
              reject(error);
            });
        } catch (error) {
          console.error('Error in archivePreviousDayData:', error);
          reject(error);
        }
      });
    }

    // Check if summary tab is active and load data if needed
    function checkSummaryTabAndLoadData() {
      // If summary tab is active and data hasn't been loaded yet
      if (document.getElementById('summary-tab').classList.contains('active')) {
        console.log('Summary tab is active, checking for data');
        
        // First try to use localStorage data if available
        const savedData = loadSummaryFromLocalStorage();
        if (savedData && Object.keys(savedData).length > 0) {
          console.log('Using saved data from localStorage for tab activation');
          summaryData = savedData;
          updateSummaryDisplay(savedData);
        }
        // Then if we have in-memory data, use that
        else if (summaryData && Object.keys(summaryData).length > 0) {
          console.log('Using existing in-memory data for tab activation');
          updateSummaryDisplay(summaryData);
        }
        // Otherwise request fresh data
        else {
          console.log('No data found, requesting fresh data');
          requestLocalSummaryData();
        }
      }
    }

    // Save data to Firebase
    function saveToFirebase(data, userId) {
      if (!firebaseInitialized) {
        console.error('Firebase not initialized yet, cannot save data');
        return;
      }
      
      try {
        console.log('Saving data to Firebase for user:', userId);
        const dbRef = firebase.database().ref('users/' + userId + '/files');
        
        // Use set to completely replace the data
        dbRef.set(data)
          .then(() => {
            console.log('Data saved to Firebase successfully');
            document.getElementById('firebase-status').textContent = 'Data synced to Firebase';
            document.getElementById('firebase-status').style.color = 'green';
            
            // Clear status message after 3 seconds
            setTimeout(() => {
              document.getElementById('firebase-status').textContent = '';
            }, 3000);
          })
          .catch((error) => {
            console.error('Error saving data to Firebase:', error);
            handleFirebaseError(error);
          });
      } catch (error) {
        console.error('Error in saveToFirebase:', error);
        handleFirebaseError(error);
      }
    }

    // Load data from Firebase
    function loadFromFirebase(userId, retryWithLocal = true) {
      if (!firebaseInitialized) {
        console.error('Firebase not initialized yet, cannot load data');
        
        if (retryWithLocal) {
          console.log('Loading summary from local data instead');
          loadSummaryFromLocal();
        }
        return;
      }
      
      try {
        console.log('Loading data from Firebase for user:', userId);
        document.getElementById('summary-loading').textContent = 'Loading data from Firebase...';
        
        const dbRef = firebase.database().ref('users/' + userId + '/files');
        
        dbRef.once('value')
          .then((snapshot) => {
            const data = snapshot.val();
            
            if (data) {
              console.log('Data loaded from Firebase:', data);
              
              // Send data to plugin
              parent.postMessage({ 
                pluginMessage: { 
                  type: 'firebase-data-loaded',
                  data: data
                } 
              }, '*');
              
              // Update UI with data
              updateSummaryDisplay(data);
              summaryLoaded = true;
              
              document.getElementById('firebase-status').textContent = 'Data loaded from Firebase';
              document.getElementById('firebase-status').style.color = 'green';
              
              // Clear status message after 3 seconds
              setTimeout(() => {
                document.getElementById('firebase-status').textContent = '';
              }, 3000);
            } else {
              console.log('No data found in Firebase');
              
              if (retryWithLocal) {
                console.log('Loading summary from local data instead');
                loadSummaryFromLocal();
              }
              
              // Notify plugin no data was found
              parent.postMessage({ 
                pluginMessage: { 
                  type: 'firebase-data-loaded',
                  data: {}
                } 
              }, '*');
            }
          })
          .catch((error) => {
            console.error('Error loading data from Firebase:', error);
            handleFirebaseError(error);
            
            if (retryWithLocal) {
              console.log('Loading summary from local data instead');
              loadSummaryFromLocal();
            }
          });
      } catch (error) {
        console.error('Error in loadFromFirebase:', error);
        handleFirebaseError(error);
        
        if (retryWithLocal) {
          console.log('Loading summary from local data instead');
          loadSummaryFromLocal();
        }
      }
    }

    // Load summary from local data
    function loadSummaryFromLocal() {
      console.log('Requesting local summary data');
      document.getElementById('summary-loading').textContent = 'Loading from local data...';
      
      // Request summary data from plugin
      parent.postMessage({ pluginMessage: { 
        type: 'get-summary',
        immediate: true
      } }, '*');
    }

    // Update file info display
    function updateFileInfo(fileName, pageName) {
      console.log('Updating file info:', { fileName, pageName });
      
      // Update file name display
      const fileNameElement = document.getElementById('file-name');
      if (fileNameElement) {
        fileNameElement.textContent = fileName || 'Not selected';
      }
      
      // Update page name display
      const pageNameElement = document.getElementById('page-name');
      if (pageNameElement) {
        pageNameElement.textContent = pageName || 'Not selected';
      }
    }
    
    // Format time in HH:MM:SS
    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Format time for display (converts to hours, minutes, seconds)
    function formatTimeDisplay(seconds) {
      if (seconds < 60) {
        return `${seconds}s`;
      } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        return `${minutes}m`;
      } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
      }
    }
    
    // Update timer display based on tracking status
    function updateTimerDisplay(tracking, startTime) {
      console.log('Updating timer display:', { tracking, startTime });
      
      isTracking = tracking;
      
      // Clear any existing timer interval
      if (updateTimerInterval) {
        clearInterval(updateTimerInterval);
        updateTimerInterval = null;
      }
      
      if (tracking && startTime) {
        // Store tracking start time
        trackingStartTime = startTime;
        
        // Start updating the timer every second
        updateTimerInterval = setInterval(() => {
          const now = Date.now();
          const elapsed = now - trackingStartTime;
          const seconds = Math.floor(elapsed / 1000);
          document.getElementById('timer').textContent = formatTime(seconds);
        }, 1000);
        
        // Update initial time
        const initialElapsed = Date.now() - startTime;
        const initialSeconds = Math.floor(initialElapsed / 1000);
        document.getElementById('timer').textContent = formatTime(initialSeconds);
        
        // Show the timer dot as active
        document.getElementById('timer-dot').style.display = 'block';
        
        // Update status text
        document.getElementById('status-text').textContent = 'Currently tracking';
        document.getElementById('status-text').className = 'status-active';
        
        // Update button visibility
        document.getElementById('start-button').style.display = 'none';
        document.getElementById('stop-button').style.display = 'block';
      } else {
        // Reset the timer display
        document.getElementById('timer').textContent = '00:00:00';
        
        // Hide the timer dot
        document.getElementById('timer-dot').style.display = 'none';
        
        // Update status text
        document.getElementById('status-text').textContent = 'Not tracking';
        document.getElementById('status-text').className = 'status-inactive';
        
        // Update button visibility
        document.getElementById('start-button').style.display = 'block';
        document.getElementById('stop-button').style.display = 'none';
      }
    }
    
    // Update the file list display with unified view across all files
    function updateFileList(files, currentActiveFileId) {
      const filesContainer = document.getElementById('files-container');
      filesContainer.innerHTML = '';
      
      // Store all files for future reference
      allFiles = files || [];
      
      // Update the active file ID
      if (currentActiveFileId) {
        activeFileId = currentActiveFileId;
      }
      
      console.log('Updating file list:', { 
        filesCount: allFiles.length, 
        activeFileId: activeFileId 
      });
      
      if (!allFiles || allFiles.length === 0) {
        filesContainer.innerHTML = '<div>No files tracked yet</div>';
        return;
      }
      
      // Add a summary header
      const summaryHeader = document.createElement('div');
      summaryHeader.className = 'summary-title';
      summaryHeader.textContent = 'Time Summary (All Files)';
      filesContainer.appendChild(summaryHeader);
      
      // Sort files with active file first, then by total time (most time first)
      const sortedFiles = [...allFiles].sort((a, b) => {
        // Active file always first
        if (a.id === activeFileId) return -1;
        if (b.id === activeFileId) return 1;
        
        // Then by total time
        return b.totalTime - a.totalTime;
      });
      
      // Calculate total time across all files
      const totalTimeAllFiles = sortedFiles.reduce((total, file) => total + file.totalTime, 0);
      
      // Add total time summary
      if (totalTimeAllFiles > 0) {
        const totalTimeElement = document.createElement('div');
        totalTimeElement.className = 'total-time-summary';
        totalTimeElement.innerHTML = `
          <div class="total-label">Total Time Tracked:</div>
          <div class="total-value">${formatTime(Math.floor(totalTimeAllFiles / 1000))}</div>
        `;
        filesContainer.appendChild(totalTimeElement);
      }
      
      // Create file cards
      sortedFiles.forEach(file => {
        const isCurrentlyActive = file.id === activeFileId;
        
        const fileCard = document.createElement('div');
        fileCard.className = `file-card ${isCurrentlyActive ? 'active' : ''}`;
        
        const fileHeader = document.createElement('div');
        fileHeader.className = 'file-header';
        
        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        
        // Add indicator for active file
        if (isCurrentlyActive) {
          const activeIndicator = document.createElement('span');
          activeIndicator.className = 'active-indicator';
          fileName.appendChild(activeIndicator);
        }
        
        const fileNameText = document.createElement('span');
        fileNameText.textContent = file.name;
        fileName.appendChild(fileNameText);
        
        const fileTime = document.createElement('div');
        fileTime.className = 'file-time';
        fileTime.textContent = formatTime(Math.floor(file.totalTime / 1000));
        
        fileHeader.appendChild(fileName);
        fileHeader.appendChild(fileTime);
        fileCard.appendChild(fileHeader);
        
        // Create page list if it has pages
        if (file.pages && Object.keys(file.pages).length > 0) {
          const pagesList = document.createElement('div');
          pagesList.className = 'pages-list';
          
          // Convert pages object to array and sort by tracked time
          const pagesArray = Object.values(file.pages);
          const sortedPages = [...pagesArray].sort((a, b) => {
            // Active page always first
            if (a.id === activePageId) return -1;
            if (b.id === activePageId) return 1;
            
            // Then by tracked time
            return b.totalTime - a.totalTime;
          });
          
          let hasPages = false;
          sortedPages.forEach(page => {
            // Skip pages with no tracked time unless they're active
            if (page.totalTime === 0 && page.id !== activePageId) return;
            hasPages = true;
            
            const pageRow = document.createElement('div');
            pageRow.className = `page-row ${page.id === activePageId ? 'active' : ''}`;
            
            const pageName = document.createElement('div');
            pageName.className = 'page-name';
            
            // Add indicator for active page
            if (page.id === activePageId) {
              const activeIndicator = document.createElement('span');
              activeIndicator.textContent = 'â€¢ ';
              activeIndicator.style.color = '#18a0fb';
              pageName.appendChild(activeIndicator);
            }
            
            const pageNameText = document.createElement('span');
            pageNameText.textContent = page.name;
            pageName.appendChild(pageNameText);
            
            const pageTime = document.createElement('div');
            pageTime.className = 'page-time';
            pageTime.textContent = formatTime(Math.floor(page.totalTime / 1000));
            
            pageRow.appendChild(pageName);
            pageRow.appendChild(pageTime);
            pagesList.appendChild(pageRow);
          });
          
          if (hasPages) {
            fileCard.appendChild(pagesList);
          }
        }
        
        filesContainer.appendChild(fileCard);
      });
    }
    
    // Update the UI when we receive all files data
    function handleAllFilesData(data) {
      if (!data.files) return;
      
      // Update the file list with all files data
      updateFileList(data.files, data.activeFileId);
      
      // Update any other UI elements that need all files data
      updateTotalTimeDisplay(data.files);
    }

    // Calculate and display total time across all files
    function updateTotalTimeDisplay(files) {
      if (!files || !files.length) return;
      
      // Calculate total time
      const totalSeconds = files.reduce((total, file) => {
        return total + Math.floor(file.totalTime / 1000);
      }, 0);
      
      // Update total time display if it exists
      const totalTimeElement = document.querySelector('.total-time-display');
      if (totalTimeElement) {
        totalTimeElement.textContent = formatTime(totalSeconds);
      }
    }

    // Update summary display with better file name handling and time tracking
    function updateSummaryDisplay(filesData) {
      try {
        console.log('Updating summary display with data:', 
                    filesData ? (typeof filesData === 'object' ? 
                                Object.keys(filesData).length + ' files' : 
                                typeof filesData) : 
                    'no data');
        
        // Get the summary container
        const summaryContainer = document.getElementById('summary-container');
        
        // Clear previous content
        summaryContainer.innerHTML = '';
        
        // Hide loading message
        document.getElementById('summary-loading').textContent = '';
        
        // Check if we have data
        if (!filesData || Object.keys(filesData).length === 0) {
          console.log('No files data available for summary');
          summaryContainer.innerHTML = '<p class="no-data">No tracking data available yet</p>';
          
          // Add a refresh button
          const refreshButton = document.createElement('button');
          refreshButton.textContent = 'Refresh Summary';
          refreshButton.className = 'summary-refresh-button';
          refreshButton.onclick = () => {
            console.log('Manual summary refresh requested');
            document.getElementById('summary-loading').textContent = 'Refreshing summary...';
            parent.postMessage({ pluginMessage: { type: 'get-summary', immediate: true } }, '*');
          };
          summaryContainer.appendChild(refreshButton);
          
          return;
        }
        
        // Create summary header
        const header = document.createElement('div');
        header.className = 'summary-header';
        header.innerHTML = `
          <div class="summary-title">Summary (8am-8am Cycle)</div>
          <div class="summary-refresh">
            <button id="refresh-summary">Refresh</button>
          </div>
        `;
        summaryContainer.appendChild(header);
        
        // Add refresh functionality
        document.getElementById('refresh-summary').addEventListener('click', () => {
          console.log('Manual summary refresh requested');
          document.getElementById('summary-loading').textContent = 'Refreshing summary...';
          parent.postMessage({ pluginMessage: { type: 'get-summary', immediate: true } }, '*');
        });
        
        // Create summary list
        const summaryList = document.createElement('div');
        summaryList.className = 'summary-list';
        
        // Track total time across all files
        let totalSeconds = 0;
        
        // Debug the data structure if needed
        console.log('Processing files data:', 
                   typeof filesData === 'object' ? 
                   'Object with ' + Object.keys(filesData).length + ' keys' : 
                   typeof filesData);
        
        // Sort files by time spent (descending) for better display
        const fileEntries = [];
        
        // Process each file and collect valid entries
        Object.keys(filesData).forEach((fileId) => {
          try {
            const file = filesData[fileId];
            
            // Skip invalid data
            if (!file) {
              console.log('Skipping undefined file data for ID:', fileId);
              return;
            }
            
            // Debug the file data structure
            console.log('Processing file:', fileId, 
                       'name:', file.name || 'unnamed', 
                       'totalSeconds:', file.totalSeconds || 'none',
                       'totalTime:', file.totalTime || 'none');
            
            // Get the file time (handle different formats)
            let fileSeconds = 0;
            
            if (typeof file.totalSeconds === 'number') {
              fileSeconds = file.totalSeconds;
            } else if (typeof file.totalTime === 'number') {
              fileSeconds = Math.floor(file.totalTime / 1000);
            } else if (file.time && typeof file.time === 'number') {
              fileSeconds = Math.floor(file.time / 1000);
            } else if (file.duration && typeof file.duration === 'number') {
              fileSeconds = Math.floor(file.duration / 1000);
            }
            
            // Skip files with no time tracked
            if (fileSeconds <= 0) {
              console.log('Skipping file with no time:', file.name || fileId);
              return;
            }
            
            // Get the clean file name
            let fileName = file.name || file.fileName || fileId;
            
            // Remove path if present
            if (fileName.includes('/')) {
              fileName = fileName.split('/').pop();
            }
            
            // Remove .fig extension if present
            if (fileName.endsWith('.fig')) {
              fileName = fileName.substring(0, fileName.length - 4);
            }
            
            // Add to entries array for sorting
            fileEntries.push({
              id: fileId,
              name: fileName,
              seconds: fileSeconds
            });
            
            // Add to total
            totalSeconds += fileSeconds;
          } catch (fileError) {
            console.error('Error processing file in summary:', fileError);
          }
        });
        
        // Sort by time spent (descending)
        fileEntries.sort((a, b) => b.seconds - a.seconds);
        
        // Add entries to the list
        fileEntries.forEach(entry => {
          // Format the time
          const hours = Math.floor(entry.seconds / 3600);
          const minutes = Math.floor((entry.seconds % 3600) / 60);
          const seconds = Math.floor(entry.seconds % 60);
          
          const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          
          // Create file entry
          const fileEntry = document.createElement('div');
          fileEntry.className = 'summary-file-entry';
          
          // Set the content
          fileEntry.innerHTML = `
            <div class="summary-file-name">${entry.name || 'Unnamed File'}</div>
            <div class="summary-file-time">${formattedTime}</div>
          `;
          
          // Add the entry to the list
          summaryList.appendChild(fileEntry);
        });
        
        // Add the list to the container
        summaryContainer.appendChild(summaryList);
        
        // Add total time
        const totalTimeElement = document.createElement('div');
        totalTimeElement.className = 'summary-total';
        
        // Format total time
        const totalHours = Math.floor(totalSeconds / 3600);
        const totalMinutes = Math.floor((totalSeconds % 3600) / 60);
        const totalSecs = Math.floor(totalSeconds % 60);
        
        const formattedTotal = `${totalHours.toString().padStart(2, '0')}:${totalMinutes.toString().padStart(2, '0')}:${totalSecs.toString().padStart(2, '0')}`;
        
        totalTimeElement.innerHTML = `
          <div class="summary-total-label">Total Time:</div>
          <div class="summary-total-time">${formattedTotal}</div>
        `;
        
        summaryContainer.appendChild(totalTimeElement);
        
        // Store the summary data for persistence
        if (Object.keys(filesData).length > 0) {
          summaryData = filesData;
          saveSummaryToLocalStorage(filesData);
        }
        
        console.log('Summary display updated successfully. Total time:', formattedTotal);
        
      } catch (error) {
        console.error('Error updating summary display:', error);
        
        // Show error in the summary container
        const summaryContainer = document.getElementById('summary-container');
        summaryContainer.innerHTML = `<p class="error">Error displaying summary: ${error.message}</p>`;
        
        // Add a retry button
        const retryButton = document.createElement('button');
        retryButton.textContent = 'Retry';
        retryButton.className = 'summary-retry-button';
        retryButton.onclick = () => {
          // Try to load from localStorage first
          const savedData = loadSummaryFromLocalStorage();
          if (savedData) {
            console.log('Using saved data from localStorage after error');
            updateSummaryDisplay(savedData);
          } else {
            // If no localStorage data, request from plugin
            parent.postMessage({ pluginMessage: { type: 'get-summary', immediate: true } }, '*');
          }
        };
        summaryContainer.appendChild(retryButton);
      }
    }

    // Show error message
    function showErrorMessage(message) {
      const errorContainer = document.getElementById('error-container');
      errorContainer.textContent = message;
      errorContainer.style.display = 'block';
      
      // Hide after 5 seconds
      setTimeout(() => {
        errorContainer.style.display = 'none';
      }, 5000);
    }
    
    // Handle messages from the plugin
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      console.log('Received message from plugin:', msg.type);
      
      if (msg.type === 'firebase-config') {
        console.log('Received Firebase config');
        
        // Only proceed if we have a valid config
        if (!msg.config || !msg.userId) {
          console.error('Invalid Firebase config received:', msg);
          showFirebaseError('Invalid Firebase configuration');
          return;
        }
        
        // Store user ID
        userId = msg.userId;
        
        // Mark that we're actively trying to initialize
        activelyInitializingFirebase = true;
        
        // Initialize Firebase with the provided config
        initializeFirebase(msg.config);
        
        // If we're on the summary tab, try to load data right away
        if (document.getElementById('summary-tab').classList.contains('active')) {
          setTimeout(() => {
            if (firebaseInitialized) {
              loadSummaryFromFirebase();
            }
          }, 1000);
        }
      }
      else if (msg.type === 'save-to-firebase') {
        console.log('Received save to Firebase request');
        
        if (!firebaseInitialized || !firebaseDb || !userId) {
          console.warn('Firebase not initialized, cannot save data');
          return;
        }
        
        // Check if we have files data to save
        if (msg.files && Object.keys(msg.files).length > 0) {
          // Save the full detailed tracking data
          try {
            const timeDataRef = firebaseDb.ref('timeData/' + userId);
            await timeDataRef.set(msg.files);
            console.log('Tracking data saved to Firebase successfully');
          } catch (error) {
            console.error('Error saving tracking data to Firebase:', error);
          }
          
          // If there's explicit summary data, save it to the summary path
          if (msg.summaryData && Object.keys(msg.summaryData).length > 0) {
            try {
              const summaryRef = firebaseDb.ref('summary/' + userId);
              await summaryRef.set(msg.summaryData);
              console.log('Summary data saved to Firebase successfully');
              
              // Keep a local copy for immediate access
              summaryData = msg.summaryData;
              
              // Store a backup in localStorage if available
              if (isLocalStorageAvailable()) {
                try {
                  localStorage.setItem('figmaTimeTrackSummary_backup', JSON.stringify(msg.summaryData));
                  localStorage.setItem('figmaTimeTrackSummaryTimestamp', Date.now().toString());
                } catch (e) {
                  console.warn('Failed to save summary backup to localStorage:', e);
                }
              }
              
              // Update the UI if summary tab is active
              if (document.getElementById('summary-tab').classList.contains('active')) {
                updateSummaryDisplay(msg.summaryData, 'Firebase');
              }
            } catch (error) {
              console.error('Error saving summary data to Firebase:', error);
            }
          }
          
          // Update last sync timestamp
          try {
            const syncRef = firebaseDb.ref('lastSync/' + userId);
            await syncRef.set(msg.timestamp || Date.now());
          } catch (error) {
            console.error('Error updating sync timestamp:', error);
          }
        }
      }
      else if (msg.type === 'tracking-status') {
        console.log('Received tracking status update:', msg);
        
        isTracking = msg.isTracking;
        
        // Update tracking button state
        updateTrackingButton();
        
        // Update timer display with current tracking state
        if (msg.isTracking && msg.startTime) {
          updateTimerDisplay(true, msg.startTime);
          
          // Show file info if available
          if (msg.fileName) {
            updateFileInfo(msg.fileName, msg.pageName || '');
          }
          
          // Add visual indicator to timer dot
          const timerDot = document.getElementById('timer-dot');
          if (timerDot) {
            timerDot.style.display = 'block';
            timerDot.classList.add('pulsing');
          }
          
          // Update status text
          const statusText = document.getElementById('status-text');
          if (statusText) {
            statusText.textContent = 'Tracking active';
            statusText.className = 'status-active';
          }
        } else {
          updateTimerDisplay(false, 0);
          
          // Hide timer dot
          const timerDot = document.getElementById('timer-dot');
          if (timerDot) {
            timerDot.style.display = 'none';
            timerDot.classList.remove('pulsing');
          }
          
          // Update status text
          const statusText = document.getElementById('status-text');
          if (statusText) {
            statusText.textContent = 'Tracking paused';
            statusText.className = 'status-inactive';
          }
        }
      }
      else if (msg.type === 'update-summary') {
        console.log('Received update-summary request');
        
        // If Firebase is initialized, always go to Firebase first
        if (firebaseInitialized && userId) {
          loadSummaryFromFirebase();
        } else {
          console.warn('Firebase not initialized, cannot update summary');
          showFirebaseError('Firebase not initialized');
        }
      }
      else if (msg.type === 'tracking-update') {
        // Handle tracking updates by updating our local data
        handleTrackingUpdate(msg);
      }
      // Add handling for summary data
      else if (msg.type === 'summary-data') {
        console.log('Received summary data from plugin');
        
        // Store the data in memory
        summaryData = msg.data;
        
        // Try to save to localStorage as backup, but handle errors gracefully
        if (isLocalStorageAvailable()) {
          try {
            localStorage.setItem('figmaTimeTrackSummary_backup', JSON.stringify(summaryData));
            localStorage.setItem('figmaTimeTrackSummaryTimestamp', Date.now().toString());
          } catch (e) {
            console.warn('Could not save to localStorage:', e);
          }
        }
        
        // Update the summary display
        updateSummaryDisplay(msg.data);
      }
    };

    // Load summary data from Firebase
    function loadSummaryFromFirebase(showLoading = true) {
      console.log('Loading summary data from Firebase');
      
      // Check if Firebase is initialized
      if (!firebaseInitialized || !firebaseDb) {
        console.warn('Firebase not initialized, cannot load summary');
        
        if (showLoading) {
          // Show loading with more informative message
          document.getElementById('summary-container').innerHTML = `
            <div class="firebase-loading">
              <div class="spinner"></div>
              <p>Waiting for Firebase connection...</p>
              <small>Firebase initialization in progress. Please wait.</small>
              <button id="use-local-data-btn" class="small-button">Use local data instead</button>
            </div>
          `;
          
          // Add button to use local data instead
          document.getElementById('use-local-data-btn').addEventListener('click', function() {
            useBackupData();
          });
        }
        
        // Set a timeout to fall back to local data if Firebase doesn't initialize quickly
        setTimeout(() => {
          if (!firebaseInitialized && showLoading) {
            console.warn('Firebase still not initialized after 10 seconds, falling back to local data');
            useBackupData();
          }
        }, 10000);
        
        return;
      }
      
      // Prevent multiple simultaneous Firebase requests
      if (activelyFetchingFromFirebase) {
        console.log('Already fetching from Firebase, skip duplicate request');
        return;
      }
      
      activelyFetchingFromFirebase = true;
      
      if (showLoading) {
        // Show loading indicator
        document.getElementById('summary-container').innerHTML = `
          <div class="firebase-loading">
            <div class="spinner"></div>
            <p>Loading data from Firebase...</p>
            <small id="firebase-loading-status">Connecting to database...</small>
          </div>
        `;
      }
      
      // Update loading status every second to show it's still trying
      let loadingTimeElapsed = 0;
      const loadingStatusElement = document.getElementById('firebase-loading-status');
      const loadingStatusInterval = setInterval(() => {
        loadingTimeElapsed += 1;
        if (loadingStatusElement) {
          loadingStatusElement.textContent = `Loading... (${loadingTimeElapsed}s elapsed)`;
        }
      }, 1000);
      
      // Set a longer timeout for slower connections
      const timeoutDuration = 20000; // 20 seconds
      const timeoutId = setTimeout(() => {
        clearInterval(loadingStatusInterval);
        console.warn(`Firebase fetch timed out after ${timeoutDuration/1000} seconds`);
        activelyFetchingFromFirebase = false;
        
        if (showLoading) {
          document.getElementById('summary-container').innerHTML = `
            <div class="error-container">
              <div class="error-icon">âš ï¸</div>
              <h3>Loading Timeout</h3>
              <p>Firebase data loading took too long. Using local data instead.</p>
              <button id="retry-firebase-load" class="button">Retry Firebase</button>
            </div>
          `;
          
          document.getElementById('retry-firebase-load').addEventListener('click', function() {
            loadSummaryFromFirebase();
          });
        }
        
        // Fall back to local data
        useBackupData();
      }, timeoutDuration);
      
      // Create timestamp for tracking how long the load takes
      const startTime = Date.now();
      
      // Get the reference to summary data
      firebaseDb.ref('summary/' + userId)
        .once('value')
        .then(snapshot => {
          // Clear the timeout and interval since we got data
          clearTimeout(timeoutId);
          clearInterval(loadingStatusInterval);
          
          const data = snapshot.val() || {};
          activelyFetchingFromFirebase = false;
          
          // Calculate how long it took to load
          const loadTime = Date.now() - startTime;
          console.log(`Firebase summary data loaded in ${loadTime}ms`);
          
          // If nothing found, try loading from timeData as fallback
          if (!data || Object.keys(data).length === 0) {
            console.log('No dedicated summary data found in Firebase, trying timeData...');
            
            // Try timeData instead
            firebaseDb.ref('timeData/' + userId)
              .once('value')
              .then(timeDataSnapshot => {
                const timeData = timeDataSnapshot.val() || {};
                
                if (!timeData || Object.keys(timeData).length === 0) {
                  console.log('No tracking data found in Firebase either');
                  
                  if (showLoading) {
                    document.getElementById('summary-container').innerHTML = `
                      <div class="no-data-message">
                        <p>No data found in Firebase.</p>
                        <button id="retry-firebase-btn" class="button">Retry</button>
                        <button id="use-local-btn" class="button secondary">Use Local Data</button>
                      </div>
                    `;
                    
                    document.getElementById('retry-firebase-btn').addEventListener('click', function() {
                      loadSummaryFromFirebase();
                    });
                    
                    document.getElementById('use-local-btn').addEventListener('click', function() {
                      useBackupData();
                    });
                  }
                  
                  return;
                }
                
                // Build summary from tracking data
                const generatedSummary = {};
                
                Object.keys(timeData).forEach(fileId => {
                  const file = timeData[fileId];
                  if (file && (file.totalSeconds > 0 || file.totalTime > 0)) {
                    generatedSummary[fileId] = {
                      id: fileId,
                      name: file.name,
                      totalSeconds: Math.floor((file.totalTime || 0) / 1000) || file.totalSeconds || 0
                    };
                  }
                });
                
                console.log('Generated summary from timeData:', Object.keys(generatedSummary).length, 'files');
                
                if (Object.keys(generatedSummary).length > 0) {
                  summaryData = generatedSummary;
                  
                  // Save this back as proper summary data
                  firebaseDb.ref('summary/' + userId).set(generatedSummary)
                    .then(() => {
                      console.log('Generated summary saved back to Firebase');
                    })
                    .catch(err => {
                      console.warn('Error saving generated summary back to Firebase:', err);
                    });
                  
                  // Save to localStorage as backup
                  try {
                    localStorage.setItem('figmaTimeTrackSummary_backup', JSON.stringify(generatedSummary));
                    localStorage.setItem('figmaTimeTrackSummaryTimestamp', Date.now().toString());
                  } catch (e) {
                    console.warn('Failed to save Firebase summary to localStorage:', e);
                  }
                  
                  // Update the UI with the generated summary
                  if (showLoading) {
                    updateSummaryDisplay(generatedSummary, 'Firebase (from tracking data)');
                  }
                } else {
                  console.log('Could not generate valid summary from tracking data');
                  
                  if (showLoading) {
                    useBackupData();
                  }
                }
              })
              .catch(error => {
                console.error('Error loading timeData from Firebase:', error);
                
                if (showLoading) {
                  useBackupData();
                }
              });
            
            return;
          }
          
          console.log('Summary data loaded from Firebase successfully:', Object.keys(data).length, 'files');
          summaryData = data;
          
          // Save to localStorage as backup
          try {
            localStorage.setItem('figmaTimeTrackSummary_backup', JSON.stringify(data));
            localStorage.setItem('figmaTimeTrackSummaryTimestamp', Date.now().toString());
          } catch (e) {
            console.warn('Failed to save Firebase summary to localStorage:', e);
          }
          
          // Update the UI with the fetched data if requested
          if (showLoading) {
            updateSummaryDisplay(data, 'Firebase');
          }
          
          // Update metadata to indicate we've successfully loaded data
          firebaseDb.ref('metadata/' + userId).update({
            lastSuccessfulLoad: Date.now(),
            hasValidData: true,
            loadTime: loadTime
          }).catch(err => console.warn('Error updating metadata:', err));
        })
        .catch(error => {
          clearTimeout(timeoutId);
          clearInterval(loadingStatusInterval);
          activelyFetchingFromFirebase = false;
          
          console.error('Error loading summary from Firebase:', error);
          
          if (showLoading) {
            document.getElementById('summary-container').innerHTML = `
              <div class="error-container">
                <div class="error-icon">âŒ</div>
                <h3>Firebase Error</h3>
                <p>${error.message}</p>
                <div class="button-row">
                  <button id="retry-firebase-btn" class="button">Retry</button>
                  <button id="fallback-btn" class="button secondary">Use Local Data</button>
                </div>
              </div>
            `;
            
            document.getElementById('retry-firebase-btn').addEventListener('click', function() {
              loadSummaryFromFirebase();
            });
            
            document.getElementById('fallback-btn').addEventListener('click', function() {
              useBackupData();
            });
          }
          
          // Log error for analytics
          logErrorToFirebase('firebase_load_error', error.message);
        });
    }

    // Set up real-time listener for changes to Firebase data
    function setupFirebaseDataListener() {
      if (!firebaseDb || !userId) {
        console.warn('Firebase not initialized, cannot set up data listener');
        return;
      }
      
      try {
        console.log('Setting up Firebase real-time data listeners');
        
        // Listen for changes to summary data
        const summaryRef = firebaseDb.ref('summary/' + userId);
        
        // Detach any existing listeners
        summaryRef.off();
        
        // Listen for value changes to summary data
        summaryRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            console.log('Real-time update from Firebase summary received');
            
            // Update in-memory data
            summaryData = data;
            lastSavedTimestamp = Date.now();
            
            // Always update UI if the summary tab is active
            if (document.getElementById('summary-tab').classList.contains('active')) {
              updateSummaryDisplay(data, 'Firebase (real-time)');
            }
            
            // Try to store a backup in localStorage
            try {
              localStorage.setItem('figmaTimeTrackSummary_backup', JSON.stringify(summaryData));
              localStorage.setItem('figmaTimeTrackSummaryTimestamp', Date.now().toString());
            } catch (e) {
              console.warn('Could not save Firebase summary data to localStorage backup:', e);
            }
            
            // Update UI with connection status
            updateFirebaseStatus('Summary data updated from Firebase');
          }
        }, (error) => {
          console.error('Firebase summary listener error:', error);
          handleFirebaseError(error);
        });
        
        // Also listen for time data changes as a backup
        const timeDataRef = firebaseDb.ref('timeData/' + userId);
        timeDataRef.off();
        
        timeDataRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            console.log('Real-time update from Firebase timeData received');
            trackingData = { ...data }; // Clone data for tracking
            
            // We don't immediately update the summary from timeData
            // as the summary data listener should handle that
          }
        }, (error) => {
          console.error('Firebase timeData listener error:', error);
        });
        
      } catch (error) {
        console.error('Error setting up Firebase data listener:', error);
      }
    }
    
    // Log errors to Firebase for analytics
    function logErrorToFirebase(errorType, errorMessage) {
      if (!firebaseInitialized || !firebaseDb || !userId) return;
      
      try {
        const errorRef = firebaseDb.ref(`errors/${userId}`).push();
        errorRef.set({
          type: errorType,
          message: errorMessage,
          timestamp: Date.now(),
          userAgent: navigator.userAgent,
          url: window.location.href
        }).catch(e => console.warn('Failed to log error to Firebase:', e));
      } catch (e) {
        console.warn('Error logging to Firebase:', e);
      }
    }
    
    // Display Firebase error with retry option
    function showFirebaseError(message) {
      console.error('Firebase error:', message);
      
      if (document.getElementById('summary-tab').classList.contains('active')) {
        document.getElementById('summary-container').innerHTML = `
          <div class="error-container">
            <div class="error-icon">âŒ</div>
            <h3>Firebase Error</h3>
            <p>${message}</p>
            <button id="retry-firebase-btn" class="button">Retry Connection</button>
          </div>
        `;
        
        document.getElementById('retry-firebase-btn').addEventListener('click', function() {
          // Request plugin to reinitialize Firebase
          parent.postMessage({ pluginMessage: { type: 'reinitialize-firebase' } }, '*');
          
          // Show loading again
          document.getElementById('summary-container').innerHTML = 
            '<div class="firebase-loading"><div class="spinner"></div>' + 
            '<p>Reconnecting to Firebase...</p></div>';
        });
      }
    }

    // Add function to request local summary data from the plugin
    function requestLocalSummaryData() {
      console.log('Requesting summary data from plugin');
      document.getElementById('summary-loading').textContent = 'Loading summary data...';
      
      // Request summary data from plugin
      parent.postMessage({ 
        pluginMessage: { 
          type: 'get-summary',
          immediate: true
        }
      }, '*');
    }

    // Add debugging for summary display issues
    function logSummaryDebug(message, data) {
      const debugElement = document.getElementById('summary-debug');
      if (debugElement) {
        const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
        const debugMsg = `[${timestamp}] ${message}`;
        
        let debugContent = debugElement.textContent || '';
        if (debugContent) debugContent += '\n';
        
        if (data) {
          const dataStr = typeof data === 'object' 
            ? JSON.stringify(data, null, 2) 
            : data.toString();
          debugContent += `${debugMsg}\n${dataStr}`;
        } else {
          debugContent += debugMsg;
        }
        
        // Limit debug length
        if (debugContent.length > 2000) {
          debugContent = debugContent.substring(debugContent.length - 2000);
        }
        
        debugElement.textContent = debugContent;
      }
    }

    // Check if summary tab is active and needs immediate data
    function checkSummaryTabAndLoadData() {
      // Check if summary tab is active
      const summaryTab = document.querySelector('.tab-button[data-tab="summary"]');
      const isSummaryActive = summaryTab && summaryTab.classList.contains('active');
      
      if (isSummaryActive) {
        console.log('Summary tab is active, requesting immediate data');
        // Generate summary from local data immediately
        requestLocalSummaryData();
      }
    }

    // Use backup data from memory, localStorage or empty state
    function useBackupData() {
      console.log('Using backup data sources');
      activelyFetchingFromFirebase = false;
      
      // First try in-memory data
      if (summaryData && Object.keys(summaryData).length > 0) {
        console.log('Using in-memory data');
        updateSummaryDisplay(summaryData);
        return true;
      }
      
      // Then try in-memory cache
      if (inMemoryCache && Object.keys(inMemoryCache).length > 0) {
        console.log('Using in-memory cache');
        updateSummaryDisplay(inMemoryCache);
        return true;
      }
      
      // Then try Firebase backup in localStorage
      try {
        const firebaseBackup = localStorage.getItem('figmaTimeTrackSummary_backup');
        if (firebaseBackup) {
          const parsedBackup = JSON.parse(firebaseBackup);
          console.log('Using Firebase backup from localStorage');
          summaryData = parsedBackup;
          updateSummaryDisplay(parsedBackup);
          return true;
        }
      } catch (e) {
        console.warn('Error loading Firebase backup from localStorage:', e);
      }
      
      // Then try chunked/regular localStorage data
      const localData = loadSummaryFromLocalStorage();
      if (localData && Object.keys(localData).length > 0) {
        console.log('Using localStorage data');
        summaryData = localData;
        updateSummaryDisplay(localData);
        return true;
      }
      
      // No data found
      console.log('No backup data found');
      document.getElementById('summary-container').innerHTML = 
        '<p class="no-data">No tracking data available</p>' +
        '<button class="summary-refresh-button" onclick="requestSummaryRefresh()">Refresh</button>';
      
      return false;
    }

    // Save data to Firebase
    function saveDataToFirebase(data, userId, timestamp) {
      try {
        if (!firebaseInitialized || !firebaseDb) {
          console.warn('Firebase not initialized, cannot save data');
          updateFirebaseStatus('Firebase not ready, save failed', true);
          return;
        }
        
        console.log('Saving data to Firebase for user', userId);
        updateFirebaseStatus('Saving to Firebase...');
        
        // Store in the timeData path with userId as the key
        const timeDataRef = firebaseDb.ref('timeData/' + userId);
        
        timeDataRef.set(data)
          .then(() => {
            console.log('Data saved to Firebase successfully');
            // Store the data in our local variable
            summaryData = data;
            updateFirebaseStatus('Data saved to Firebase');
          })
          .catch(error => {
            console.error('Error saving to Firebase:', error);
            updateFirebaseStatus('Firebase save error: ' + error.message, true);
          });
          
        // Also save last sync timestamp
        const syncRef = firebaseDb.ref('lastSync/' + userId);
        syncRef.set(timestamp);
      } catch (error) {
        console.error('Error in saveDataToFirebase:', error);
        updateFirebaseStatus('Firebase error: ' + error.message, true);
      }
    }

    // Update Firebase status display
    function updateFirebaseStatus(message, isError = false) {
      const statusElement = document.getElementById('firebase-status');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.style.color = isError ? 'red' : 'green';
        
        // Clear status after some time if it's not an error
        if (!isError) {
          setTimeout(() => {
            statusElement.textContent = '';
          }, 5000);
        }
      }
    }

    // Set up tabs functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded - setting up tab buttons');
      
      // Get tab buttons and add click listeners
      const tabButtons = document.querySelectorAll('.tab-button');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const tabId = this.getAttribute('data-tab');
          console.log('Tab clicked:', tabId);
          
          // Remove active class from all buttons and contents
          document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
          });
          
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          
          // Add active class to clicked button and corresponding content
          this.classList.add('active');
          
          const content = document.getElementById(tabId);
          if (content) {
            content.classList.add('active');
            
            // Special handling for summary tab
            if (tabId === 'summary-tab') {
              console.log('Summary tab activated');
              document.getElementById('summary-loading').textContent = 'Loading summary...';
              
              // Use stored data immediately if available
              if (summaryData) {
                console.log('Using stored summary data for immediate display');
                updateSummaryDisplay(summaryData);
              } else {
                // Try loading from localStorage
                const savedData = loadSummaryFromLocalStorage();
                if (savedData) {
                  console.log('Using localStorage data for immediate display');
                  summaryData = savedData;
                  updateSummaryDisplay(savedData);
                }
              }
              
              // Request fresh data
              setTimeout(() => {
                requestSummaryRefresh();
              }, 200);
            }
          }
        });
      });
      
      // Set up other button event listeners
      
      // Start button
      document.getElementById('start-button').addEventListener('click', function() {
        parent.postMessage({ pluginMessage: { type: 'start-tracking' } }, '*');
      });
      
      // Stop button
      document.getElementById('stop-button').addEventListener('click', function() {
        parent.postMessage({ pluginMessage: { type: 'stop-tracking' } }, '*');
      });
      
      // Background tracking toggle
      document.getElementById('background-tracking').addEventListener('change', function(e) {
        const enabled = e.target.checked;
        console.log('Background tracking toggled:', enabled);
        parent.postMessage({ 
          pluginMessage: { 
            type: 'toggle-background-tracking', 
            enabled: enabled 
          }
        }, '*');
      });
      
      // Firebase sync buttons
      document.getElementById('sync-to-firebase').addEventListener('click', function() {
        console.log('Manual sync to Firebase requested');
        parent.postMessage({ pluginMessage: { type: 'sync-to-firebase' } }, '*');
      });
      
      document.getElementById('sync-from-firebase').addEventListener('click', function() {
        console.log('Manual sync from Firebase requested');
        parent.postMessage({ pluginMessage: { type: 'sync-from-firebase' } }, '*');
      });
    });

    // Show storage warning
    function showStorageWarning() {
      // Only show once per session
      if (localStorage.getItem('storageWarningShown')) {
        return;
      }
      
      // Create the warning element if it doesn't exist
      let warningElement = document.getElementById('storage-warning');
      if (!warningElement) {
        warningElement = document.createElement('div');
        warningElement.id = 'storage-warning';
        warningElement.className = 'warning-message';
        warningElement.innerHTML = `
          <div class="message-title">Storage Limitation</div>
          <p>Your browser's storage is approaching its limit. The plugin will keep your most recent 
          tracking data, but older entries may not be saved locally.</p>
          <div class="message-action">
            <button id="dismiss-storage-warning">Dismiss</button>
          </div>
        `;
        
        // Add to the top of the active tab
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) {
          activeTab.insertBefore(warningElement, activeTab.firstChild);
          
          // Add dismiss button handler
          document.getElementById('dismiss-storage-warning').addEventListener('click', function() {
            warningElement.style.display = 'none';
            localStorage.setItem('storageWarningShown', 'true');
          });
        }
      }
    }

    // Check localStorage status and update UI
    function checkStorageStatus() {
      try {
        // Display container
        document.getElementById('storage-status-indicator').className = 'status-indicator';
        
        // Test localStorage availability
        const testKey = 'figmaTimeTrack_storageTest';
        
        try {
          localStorage.setItem(testKey, '1');
          localStorage.removeItem(testKey);
          
          // Check how much is used
          let totalSize = 0;
          let trackerSize = 0;
          
          // Estimate current usage
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            const size = (key.length + value.length) * 2; // Unicode is 2 bytes per char
            
            totalSize += size;
            
            if (key.startsWith('figmaTimeTrack')) {
              trackerSize += size;
            }
          }
          
          // Check how much is used by our app
          const usagePercent = Math.min(100, Math.round((trackerSize / 5000000) * 100)); // Assumes 5MB limit
          
          // Update the indicator
          const statusIndicator = document.getElementById('storage-status-indicator');
          const storageUsage = document.getElementById('storage-usage');
          
          if (usagePercent < 50) {
            statusIndicator.className = 'status-indicator good';
            storageUsage.innerHTML = `Storage usage: ${formatStorageSize(trackerSize)} (${usagePercent}% of limit)`;
            storageUsage.style.color = '#34c759';
          } else if (usagePercent < 80) {
            statusIndicator.className = 'status-indicator warning';
            storageUsage.innerHTML = `Storage usage: ${formatStorageSize(trackerSize)} (${usagePercent}% of limit)`;
            storageUsage.style.color = '#ffcc00';
          } else {
            statusIndicator.className = 'status-indicator error';
            storageUsage.innerHTML = `Storage usage: ${formatStorageSize(trackerSize)} (${usagePercent}% of limit)<br>Your data may not fully save. Consider clearing storage.`;
            storageUsage.style.color = '#ff3b30';
          }
          
          // Set up clear storage button
          document.getElementById('clear-storage').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all locally stored data? This cannot be undone.')) {
              clearAllLocalStorage();
              checkStorageStatus();
            }
          });
          
        } catch (error) {
          // localStorage is not available
          document.getElementById('storage-status-indicator').className = 'status-indicator error';
          document.getElementById('storage-usage').innerHTML = 'Error: Local storage is not available on this browser';
          document.getElementById('storage-usage').style.color = '#ff3b30';
          console.error('localStorage is not available:', error);
        }
      } catch (error) {
        console.error('Error checking storage status:', error);
      }
    }
    
    // Format storage size for display
    function formatStorageSize(bytes) {
      if (bytes < 1024) {
        return bytes + ' bytes';
      } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(1) + ' KB';
      } else {
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
    }
    
    // Clear all localStorage related to this app
    function clearAllLocalStorage() {
      try {
        // First clear chunks
        clearChunkedData();
        
        // Clear any other storage
        const keysToRemove = [];
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('figmaTimeTrack')) {
            keysToRemove.push(key);
          }
        }
        
        // Remove all keys
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
        });
        
        console.log(`Cleared ${keysToRemove.length} items from localStorage`);
        
        // Reset summaryData
        summaryData = null;
        inMemoryCache = {};
        
        // Update UI
        const storageUsage = document.getElementById('storage-usage');
        storageUsage.innerHTML = 'Storage cleared successfully';
        storageUsage.style.color = '#34c759';
        
        // Show a message to the user
        alert('Local storage has been cleared successfully.');
      } catch (error) {
        console.error('Error clearing localStorage:', error);
      }
    }

    // Save just the most recent update to Firebase (more efficient)
    function saveRecentUpdateToFirebase(fileId, fileData) {
      if (!firebaseInitialized || !firebaseDb || !userId) {
        console.warn('Firebase not ready, cannot save recent update');
        return false;
      }
      
      try {
        console.log('Saving update for file to Firebase:', fileData.name);
        
        // Get the reference to just this file's data
        const fileRef = firebaseDb.ref('timeData/' + userId + '/' + fileId);
        
        // Set the data for this file
        fileRef.update(fileData)
          .then(() => {
            console.log('File update saved to Firebase successfully');
            updateFirebaseStatus('Data synced to Firebase');
            
            // Also update the last sync timestamp
            firebaseDb.ref('lastSync/' + userId).set(Date.now());
          })
          .catch((error) => {
            console.error('Error saving file update to Firebase:', error);
            handleFirebaseError(error);
            return false;
          });
          
        return true;
      } catch (error) {
        console.error('Error in saveRecentUpdateToFirebase:', error);
        return false;
      }
    }

    // Auto-save to Firebase every few minutes if there are changes
    let lastAutoSaveTimestamp = 0;
    setInterval(() => {
      // Only auto-save if we have Firebase initialized and data has changed
      if (firebaseInitialized && firebaseDb && userId && trackingData && Object.keys(trackingData).length > 0) {
        const now = Date.now();
        
        // Check if it's been at least 2 minutes since last auto-save
        if (now - lastAutoSaveTimestamp > 2 * 60 * 1000) {
          console.log('Auto-saving data to Firebase');
          
          // Save all tracking data to Firebase
          const timeDataRef = firebaseDb.ref('timeData/' + userId);
          timeDataRef.update(trackingData)
            .then(() => {
              console.log('Auto-save to Firebase successful');
              lastAutoSaveTimestamp = now;
              
              // Also save metadata about this auto-save
              firebaseDb.ref('metadata/' + userId).update({
                lastAutoSave: now,
                hasValidData: true
              }).catch(err => console.warn('Error updating auto-save metadata:', err));
            })
            .catch(error => {
              console.error('Auto-save to Firebase failed:', error);
            });
        }
      }
    }, 60 * 1000); // Check every minute, but only save every 2+ minutes

    // Monitor Firebase connection status
    function setupFirebaseConnectionMonitor() {
      if (!firebaseInitialized || !firebaseDb) {
        console.warn('Cannot setup Firebase connection monitor, not initialized');
        return;
      }
      
      try {
        console.log('Setting up Firebase connection monitor');
        
        const connectedRef = firebaseDb.ref('.info/connected');
        connectedRef.on('value', (snap) => {
          if (snap.val() === true) {
            console.log('Connected to Firebase');
            updateFirebaseConnectionStatus('connected');
          } else {
            console.log('Not connected to Firebase');
            updateFirebaseConnectionStatus('disconnected');
          }
        });
      } catch (error) {
        console.error('Error setting up Firebase connection monitor:', error);
      }
    }
    
    // Update Firebase connection status
    function updateFirebaseConnectionStatus(status) {
      console.log('Firebase connection status:', status);
      
      // Update UI with connection status
      document.querySelectorAll('.tab-button').forEach(button => {
        if (button.getAttribute('data-tab') === 'summary-tab') {
          const indicator = button.querySelector('.firebase-indicator');
          
          if (!indicator) {
            const newIndicator = document.createElement('span');
            newIndicator.className = 'firebase-indicator ' + status;
            button.appendChild(newIndicator);
          } else {
            indicator.className = 'firebase-indicator ' + status;
          }
        }
      });
    }

    // Record session end when page is unloaded
    window.addEventListener('beforeunload', function() {
      if (firebaseDb && userId && currentSessionId) {
        try {
          // Make a synchronous request to mark session as ended
          const xhr = new XMLHttpRequest();
          const sessionEndPoint = `${firebaseConfig.databaseURL}/sessions/${userId}/${currentSessionId}/status.json`;
          xhr.open('PUT', sessionEndPoint, false); // false makes it synchronous
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(JSON.stringify('ended'));
          
          console.log('Recorded session end in Firebase');
        } catch (e) {
          console.warn('Failed to record session end:', e);
        }
      }
    });

    // Function to handle tab button clicks
    function handleTabButtonClick(tabId) {
      console.log('Tab clicked:', tabId);
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to clicked tab button
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      
      // Hide all tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabId).classList.add('active');
      
      // Handle specific tabs
      if (tabId === 'summary-tab') {
        handleSummaryTabActivation();
      }
      else if (tabId === 'tracking-tab') {
        // Anything special for tracking tab
        console.log('Tracking tab activated');
      }
    }

    // Use backup data with source indicator
    function useBackupData(reason = 'Firebase timeout') {
      console.log('Using backup data, reason:', reason);
      
      try {
        // First try to get from in-memory summaryData
        if (summaryData && Object.keys(summaryData).length > 0) {
          console.log('Using in-memory summary data');
          updateSummaryDisplay(summaryData, 'Memory Cache');
          return;
        }
        
        // Then try localStorage if available
        if (isLocalStorageAvailable()) {
          const savedData = loadSummaryFromLocalStorage();
          if (savedData) {
            console.log('Using localStorage backup data');
            summaryData = savedData; // Update in-memory copy
            updateSummaryDisplay(savedData, 'Local Storage');
            return;
          }
        }
        
        // If still no data, request from plugin
        console.log('No backup data available, requesting from plugin');
        parent.postMessage({ pluginMessage: { type: 'get-summary', immediate: true } }, '*');
        
      } catch (e) {
        console.error('Error using backup data:', e);
        // Request from plugin as last resort
        parent.postMessage({ pluginMessage: { type: 'get-summary', immediate: true } }, '*');
      }
    }
    
    // Update summary display with data source indicator
    function updateSummaryDisplay(data, dataSource = 'Firebase') {
      console.log('Updating summary display with data source:', dataSource);
      
      try {
        const summaryContainer = document.getElementById('summary-container');
        
        if (!data || Object.keys(data).length === 0) {
          summaryContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ðŸ“Š</div>
              <h3>No Time Tracked Yet</h3>
              <p>Start working on your files to track time.</p>
              <button id="refresh-summary-btn" class="button">Refresh</button>
            </div>
          `;
          
          document.getElementById('refresh-summary-btn').addEventListener('click', function() {
            refreshSummary();
          });
          return;
        }
        
        // Start building the summary HTML with data source indicator
        let summaryHtml = `
          <div class="summary-header">
            <h3>Time Spent Per File</h3>
            <span class="data-source">Data source: ${dataSource}</span>
          </div>
          <ul class="summary-list">
        `;
        
        // Sort files by total time (descending)
        const sortedFiles = Object.values(data).sort((a, b) => {
          const aTime = a.totalSeconds || 0;
          const bTime = b.totalSeconds || 0;
          return bTime - aTime;
        });
        
        // Add file entries to the list
        for (const file of sortedFiles) {
          if (!file || !file.id || !file.name) {
            console.warn('Skipping invalid file entry:', file);
            continue;
          }
          
          // Get time in seconds, accounting for different data formats
          const seconds = file.totalSeconds || 
                          (file.totalTime ? Math.floor(file.totalTime / 1000) : 0) ||
                          (file.time || 0) ||
                          (file.duration || 0);
          
          if (seconds <= 0) {
            console.log('Skipping file with no time:', file.name);
            continue;
          }
          
          // Format the time for display
          const formattedTime = formatTime(seconds);
          
          // Extract filename without path and extension for cleaner display
          let displayName = file.name;
          try {
            // Strip out path if present (keep just the filename)
            displayName = displayName.split('/').pop().split('\\').pop();
            // Remove file extension if present
            if (displayName.includes('.')) {
              displayName = displayName.substring(0, displayName.lastIndexOf('.'));
            }
          } catch (e) {
            console.warn('Error formatting filename:', e);
          }
          
          // Add to summary HTML
          summaryHtml += `
            <li class="summary-item">
              <div class="summary-file-name">${displayName}</div>
              <div class="summary-time">${formattedTime}</div>
            </li>
          `;
        }
        
        // Calculate and add total time
        let totalSeconds = 0;
        for (const file of sortedFiles) {
          totalSeconds += file.totalSeconds || 
                         (file.totalTime ? Math.floor(file.totalTime / 1000) : 0) ||
                         (file.time || 0) ||
                         (file.duration || 0);
        }
        
        // Add total time to summary
        summaryHtml += `
            </ul>
            <div class="summary-total">
              <div class="summary-total-label">Total Time</div>
              <div class="summary-total-time">${formatTime(totalSeconds)}</div>
            </div>
            <div class="summary-actions">
              <button id="refresh-summary-btn" class="button">Refresh</button>
              <button id="sync-firebase-btn" class="button">Force Firebase Sync</button>
            </div>
        `;
        
        // Update the container
        summaryContainer.innerHTML = summaryHtml;
        
        // Add event listeners for buttons
        document.getElementById('refresh-summary-btn').addEventListener('click', function() {
          refreshSummary();
        });
        
        document.getElementById('sync-firebase-btn').addEventListener('click', function() {
          parent.postMessage({ pluginMessage: { type: 'sync-to-firebase' } }, '*');
          setTimeout(() => {
            refreshSummary();
          }, 1000);
        });
      } catch (error) {
        console.error('Error displaying summary:', error);
        document.getElementById('summary-container').innerHTML = `
          <div class="error-message">
            <p>Error displaying summary: ${error.message}</p>
            <button id="retry-summary-btn" class="button">Retry</button>
          </div>
        `;
        
        document.getElementById('retry-summary-btn').addEventListener('click', function() {
          refreshSummary();
        });
      }
    }

    // Refresh summary data from Firebase
    function refreshSummary() {
      console.log('Manual refresh summary requested');
      
      // Show loading indicator
      document.getElementById('summary-container').innerHTML = 
        '<div class="firebase-loading"><div class="spinner"></div>' + 
        '<p>Refreshing data from Firebase...</p></div>';
      
      // Try Firebase first if available
      if (firebaseInitialized && userId) {
        console.log('Requesting fresh data from Firebase');
        loadSummaryFromFirebase();
      }
      // If Firebase is initializing, wait for it
      else if (activelyInitializingFirebase) {
        console.log('Firebase is initializing, waiting...');
        setTimeout(() => {
          if (firebaseInitialized) {
            loadSummaryFromFirebase();
          } else {
            // Still not initialized after delay, use backup
            useBackupData('Firebase initialization timeout');
          }
        }, 5000);
      }
      // Otherwise, fallback to local data
      else {
        console.warn('Firebase not available for refresh, using backup');
        useBackupData('Firebase unavailable');
        
        // Also try to re-initialize Firebase
        parent.postMessage({ pluginMessage: { type: 'ui-loaded' } }, '*');
      }
    }
    
    // Update Firebase status indicator
    function updateFirebaseStatus(status) {
      console.log('Firebase status:', status);
      // Optionally display the status in the UI
      const statusIndicator = document.getElementById('firebase-status');
      if (statusIndicator) {
        statusIndicator.textContent = status;
      }
    }
    
    // Setup Firebase data listener for real-time updates
    function setupFirebaseDataListener() {
      if (!firebaseInitialized || !firebaseDb || !userId) {
        console.warn('Cannot setup Firebase listener, not initialized');
        return;
      }
      
      try {
        console.log('Setting up Firebase real-time data listener');
        
        // Reference to user's time data
        const userDataRef = firebaseDb.ref('timeData/' + userId);
        
        // Listen for changes
        userDataRef.on('value', (snapshot) => {
          const data = snapshot.val();
          console.log('Firebase data updated in real-time');
          
          if (data && Object.keys(data).length > 0) {
            // Store the updated data
            summaryData = data;
            
            // Update localStorage backup
            try {
              localStorage.setItem('figmaTimeTrackSummary_backup', JSON.stringify(data));
              localStorage.setItem('figmaTimeTrackSummaryTimestamp', Date.now().toString());
            } catch (e) {
              console.warn('Could not save Firebase data to localStorage backup:', e);
            }
            
            // Update the UI if summary tab is active
            if (document.getElementById('summary-tab').classList.contains('active')) {
              updateSummaryDisplay(data);
            }
          }
        }, (error) => {
          console.error('Firebase data listener error:', error);
          handleFirebaseError(error);
        });
      } catch (error) {
        console.error('Error setting up Firebase data listener:', error);
      }
    }
    
    // Setup Firebase connection monitor
    function setupFirebaseConnectionMonitor() {
      if (!firebaseInitialized || !firebaseDb) {
        console.warn('Cannot setup Firebase connection monitor, not initialized');
        return;
      }
      
      try {
        console.log('Setting up Firebase connection monitor');
        
        const connectedRef = firebaseDb.ref('.info/connected');
        connectedRef.on('value', (snap) => {
          if (snap.val() === true) {
            console.log('Connected to Firebase');
            updateFirebaseConnectionStatus('connected');
          } else {
            console.log('Not connected to Firebase');
            updateFirebaseConnectionStatus('disconnected');
          }
        });
      } catch (error) {
        console.error('Error setting up Firebase connection monitor:', error);
      }
    }
    
    // Update Firebase connection status
    function updateFirebaseConnectionStatus(status) {
      console.log('Firebase connection status:', status);
      
      // Update UI with connection status
      document.querySelectorAll('.tab-button').forEach(button => {
        if (button.getAttribute('data-tab') === 'summary-tab') {
          const indicator = button.querySelector('.firebase-indicator');
          
          if (!indicator) {
            const newIndicator = document.createElement('span');
            newIndicator.className = 'firebase-indicator ' + status;
            button.appendChild(newIndicator);
          } else {
            indicator.className = 'firebase-indicator ' + status;
          }
        }
      });
    }
    
    // Initialize UI elements
    function initializeUI() {
      console.log('Initializing UI elements');
      
      // Set up tab navigation if not already set up
      document.querySelectorAll('.tab-button').forEach(button => {
        const tabId = button.getAttribute('data-tab');
        console.log('Setting up tab button for', tabId);
        
        if (!button.hasAttribute('data-initialized')) {
          button.setAttribute('data-initialized', 'true');
          
          // Add Firebase status indicator for summary tab
          if (tabId === 'summary-tab') {
            const indicator = document.createElement('span');
            indicator.className = 'firebase-indicator initializing';
            button.appendChild(indicator);
          }
        }
      });
      
      // Activate the first tab by default
      const firstTab = document.querySelector('.tab-button:first-child');
      if (firstTab) {
        const tabId = firstTab.getAttribute('data-tab');
        handleTabButtonClick(tabId);
      }
      
      // Set up background tracking toggle listener
      const bgTrackToggle = document.getElementById('bg-track-toggle');
      if (bgTrackToggle) {
        bgTrackToggle.addEventListener('change', function() {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'toggle-background-tracking', 
              enabled: this.checked 
            } 
          }, '*');
        });
      }
      
      // Add global status area if not present
      if (!document.getElementById('firebase-status-container')) {
        const statusContainer = document.createElement('div');
        statusContainer.id = 'firebase-status-container';
        statusContainer.innerHTML = `
          <div id="firebase-status" class="status-message"></div>
        `;
        document.body.appendChild(statusContainer);
      }
    }

    // Handle tracking update from the plugin and store in Firebase
    function handleTrackingUpdate(msg) {
      console.log('Received tracking update', msg.file ? msg.file.name : 'no file');
      
      if (!msg.file || !msg.file.id) {
        console.warn('Tracking update missing file ID');
        return;
      }
      
      // Update tracking data in memory
      const fileId = msg.file.id;
      const fileName = msg.file.name;
      
      if (!summaryData) {
        summaryData = {};
      }
      
      // Create file entry if it doesn't exist
      if (!summaryData[fileId]) {
        summaryData[fileId] = {
          id: fileId,
          name: fileName,
          totalSeconds: 0,
          lastUpdated: Date.now()
        };
      }
      
      // Convert time to seconds if needed
      let timeInSeconds = 0;
      if (typeof msg.time === 'number') {
        if (msg.time > 10000) {
          // Assume milliseconds
          timeInSeconds = Math.floor(msg.time / 1000);
        } else {
          // Assume seconds
          timeInSeconds = msg.time;
        }
      }
      
      // Update the tracking data
      summaryData[fileId].totalSeconds = (summaryData[fileId].totalSeconds || 0) + timeInSeconds;
      summaryData[fileId].lastUpdated = Date.now();
      
      console.log('Updated tracking data for file:', summaryData[fileId].name, 
                  'total time:', formatTime(summaryData[fileId].totalSeconds));
      
      // Save to Firebase if initialized
      if (firebaseInitialized && firebaseDb && userId) {
        console.log('Saving tracking update to Firebase');
        
        // Update the specific file data
        firebaseDb.ref(`timeData/${userId}/${fileId}`).update({
          id: fileId,
          name: fileName,
          totalSeconds: summaryData[fileId].totalSeconds,
          lastUpdated: Date.now()
        }).then(() => {
          console.log('Successfully saved tracking update to Firebase');
          
          // Update metadata to indicate we have valid data
          return firebaseDb.ref(`metadata/${userId}`).update({
            lastUpdated: Date.now(),
            hasValidData: true
          });
        }).catch(error => {
          console.error('Error saving tracking update to Firebase:', error);
          handleFirebaseError(error);
        });
      } else {
        console.warn('Firebase not initialized, update not saved to Firebase');
      }
      
      // Update the UI if summary tab is active
      if (document.getElementById('summary-tab').classList.contains('active')) {
        updateSummaryDisplay(summaryData);
      }
    }
    
    // Update tracking button state
    function updateTrackingButton() {
      const startButton = document.getElementById('start-button');
      const stopButton = document.getElementById('stop-button');
      
      if (!startButton || !stopButton) return;
      
      if (isTracking) {
        startButton.style.display = 'none';
        stopButton.style.display = 'block';
      } else {
        startButton.style.display = 'block';
        stopButton.style.display = 'none';
      }
    }

    // Load summary data from localStorage as a fallback
    function loadSummaryFromLocalStorage() {
      console.log('Loading summary data from localStorage fallback');
      
      try {
        // Try to get data from localStorage
        const backupData = localStorage.getItem('figmaTimeTrackSummary_backup');
        
        if (!backupData) {
          console.log('No summary data found in localStorage');
          return null;
        }
        
        // Parse the data
        const savedData = JSON.parse(backupData);
        
        if (!savedData || Object.keys(savedData).length === 0) {
          console.log('Empty data in localStorage');
          return null;
        }
        
        console.log('Successfully loaded summary data from localStorage');
        return savedData;
      } catch (error) {
        console.error('Error loading summary from localStorage:', error);
        return null;
      }
    }

    // Define requestSummaryRefresh function at global scope
    function requestSummaryRefresh() {
      console.log('Summary refresh requested');
      document.getElementById('summary-loading').textContent = 'Refreshing summary...';
      
      // Try Firebase first if available
      if (firebaseInitialized && userId) {
        loadSummaryFromFirebase();
      } else {
        // Request from the plugin directly
        parent.postMessage({ 
          pluginMessage: { 
            type: 'get-summary', 
            immediate: true 
          } 
        }, '*');
      }
    }

    // Handle summary tab activation
    function handleSummaryTabActivation() {
      console.log('Summary tab activated');
      document.getElementById('summary-loading').textContent = 'Loading summary...';
      
      // Display immediate data from in-memory cache if available
      if (summaryData && Object.keys(summaryData).length > 0) {
        console.log('Using in-memory summary data for immediate display');
        updateSummaryDisplay(summaryData);
      }
      
      // Request fresh data from Firebase if available
      if (firebaseInitialized && userId) {
        console.log('Requesting fresh data from Firebase');
        setTimeout(() => {
          loadSummaryFromFirebase();
        }, 200);
      } else {
        // Try safely loading from localStorage first
        try {
          const savedData = loadSummaryFromLocalStorage();
          if (savedData) {
            console.log('Using localStorage data');
            summaryData = savedData;
            updateSummaryDisplay(savedData);
          } else {
            // Request from plugin as fallback
            console.log('No localStorage data, requesting from plugin');
            parent.postMessage({ pluginMessage: { type: 'get-summary', immediate: true } }, '*');
          }
        } catch (e) {
          console.error('Error accessing localStorage:', e);
          // Skip localStorage completely and get data from plugin
          console.log('localStorage error, requesting from plugin');
          parent.postMessage({ pluginMessage: { type: 'get-summary', immediate: true } }, '*');
        }
      }
    }

    // Safe check for localStorage availability
    function isLocalStorageAvailable() {
      try {
        const testKey = 'test';
        localStorage.setItem(testKey, testKey);
        localStorage.removeItem(testKey);
        return true;
      } catch (e) {
        return false;
      }
    }
</script>
</body>
</html>

