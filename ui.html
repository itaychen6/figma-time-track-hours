<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      color: #333;
      background: #fff;
    }
    
    .container {
      max-width: 100%;
      padding: 0;
    }
    
    .tab-navigation {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .tab-button {
      padding: 8px 16px;
      border: none;
      background: none;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .tab-button.active {
      color: #18A0FB;
      border-bottom-color: #18A0FB;
    }
    
    .tab-content {
      display: none;
      padding: 16px 0;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tracking-status {
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    
    .tracking-status.active {
      background: #E3F2FD;
      color: #1976D2;
    }
    
    .file-info {
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .timer-display {
      font-size: 24px;
      font-weight: 500;
      text-align: center;
      margin: 24px 0;
      color: #18A0FB;
    }
    
    .button-container {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    button {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    button.primary {
      background: #18A0FB;
      color: white;
    }
    
    button.secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    .summary-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .today-total {
      font-size: 16px;
      font-weight: 500;
      padding: 12px;
      background: #f0f7ff;
      border-radius: 6px;
      color: #18A0FB;
      margin-bottom: 16px;
    }
    
    .page-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .page-summary.recent {
      background: #E3F2FD;
      border-left: 3px solid #2196F3;
    }
    
    .page-summary.today {
      border-left: 3px solid #18A0FB;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .no-data {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="tracking-tab">Tracking</button>
      <button class="tab-button" data-tab="summary-tab">Summary</button>
    </div>
    
    <div id="tracking-tab" class="tab-content active">
      <div id="tracking-status" class="tracking-status">
        Waiting to start tracking...
      </div>
      
      <div class="file-info">
        <div id="file-name"></div>
        <div id="page-name"></div>
      </div>
      
      <div id="timer-display" class="timer-display">
        0h 0m
      </div>
      
      <div class="button-container">
        <button id="start-button" class="primary">Start Tracking</button>
        <button id="stop-button" class="secondary" style="display: none;">Stop</button>
      </div>
    </div>
    
    <div id="summary-tab" class="tab-content">
      <div id="summary-content" class="summary-content">
        <div class="loading">Loading summary...</div>
      </div>
    </div>
  </div>
  
  <script>
    let activeTab = 'tracking-tab';
    let isTracking = false;
    let currentSession = null;
    let updateTimer = null;
    
    // Initialize UI
    document.addEventListener('DOMContentLoaded', () => {
      setupTabButtons();
      setupTrackingButtons();
      parent.postMessage({ pluginMessage: { type: 'ui-loaded' } }, '*');
    });
    
    // Set up tab navigation
    function setupTabButtons() {
      const tabs = document.querySelectorAll('.tab-button');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          activateTab(tabId);
        });
      });
    }
    
    function activateTab(tabId) {
      // Update buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      });
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabId);
      });
      
      activeTab = tabId;
      
      // Update height
      const activeContent = document.getElementById(tabId);
      parent.postMessage({ 
        pluginMessage: { 
          type: 'resize',
          height: activeContent.offsetHeight + 100
        }
      }, '*');
    }
    
    // Set up tracking buttons
    function setupTrackingButtons() {
      const startButton = document.getElementById('start-button');
      const stopButton = document.getElementById('stop-button');
      
      startButton.addEventListener('click', () => {
        parent.postMessage({ pluginMessage: { type: 'start-tracking' } }, '*');
      });
      
      stopButton.addEventListener('click', () => {
        parent.postMessage({ pluginMessage: { type: 'stop-tracking' } }, '*');
      });
    }
    
    // Update tracking status
    function updateTrackingStatus(tracking, fileName, pageName) {
      const status = document.getElementById('tracking-status');
      const fileNameEl = document.getElementById('file-name');
      const pageNameEl = document.getElementById('page-name');
      const startButton = document.getElementById('start-button');
      const stopButton = document.getElementById('stop-button');
      
      status.classList.toggle('active', tracking);
      status.textContent = tracking ? 'Currently tracking time...' : 'Waiting to start tracking...';
      
      fileNameEl.textContent = `File: ${fileName || 'None'}`;
      pageNameEl.textContent = `Page: ${pageName || 'None'}`;
      
      startButton.style.display = tracking ? 'none' : 'block';
      stopButton.style.display = tracking ? 'block' : 'none';
      
      isTracking = tracking;
    }
    
    // Update timer display
    function updateTimerDisplay() {
      if (!isTracking || !currentSession) return;
      
      const now = Date.now();
      const elapsed = Math.floor((now - currentSession.startTime) / 1000);
      document.getElementById('timer-display').textContent = formatDuration(elapsed);
    }
    
    // Format duration
    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}h ${minutes}m`;
    }
    
    // Update summary display
    function updateSummaryDisplay(files) {
      const container = document.getElementById('summary-content');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!files || Object.keys(files).length === 0) {
        container.innerHTML = '<div class="no-data">No tracking data available</div>';
        return;
      }
      
      // Calculate today's total
      const now = new Date();
      const todayStart = new Date(now);
      todayStart.setHours(6, 0, 0, 0);
      if (now.getHours() < 6) {
        todayStart.setDate(todayStart.getDate() - 1);
      }
      
      let todayTotal = 0;
      const allPages = [];
      
      // Collect all pages and calculate today's total
      Object.values(files).forEach(file => {
        if (!file.pages) return;
        
        Object.values(file.pages).forEach(page => {
          if (page.lastUpdated >= todayStart.getTime()) {
            todayTotal += page.totalTime;
          }
          allPages.push(page);
        });
      });
      
      // Create today's total header
      const totalHeader = document.createElement('div');
      totalHeader.className = 'today-total';
      totalHeader.textContent = `Today Total: ${formatDuration(Math.floor(todayTotal / 1000))}`;
      container.appendChild(totalHeader);
      
      // Sort pages by total time
      const sortedPages = allPages
        .filter(page => page.totalTime > 0)
        .sort((a, b) => b.totalTime - a.totalTime);
      
      // Create pages list
      sortedPages.forEach(page => {
        const pageElement = document.createElement('div');
        pageElement.className = 'page-summary';
        
        if (page.lastUpdated >= todayStart.getTime()) {
          pageElement.classList.add('today');
        }
        
        const pageName = document.createElement('div');
        pageName.textContent = page.name;
        
        const pageTime = document.createElement('div');
        pageTime.textContent = formatDuration(Math.floor(page.totalTime / 1000));
        
        pageElement.appendChild(pageName);
        pageElement.appendChild(pageTime);
        container.appendChild(pageElement);
      });
    }
    
    // Handle messages from the plugin
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'update') {
        // Update tracking status
        updateTrackingStatus(
          msg.tracking,
          msg.currentFile ? files[msg.currentFile]?.name : 'None',
          msg.currentPage ? files[msg.currentFile]?.pages[msg.currentPage]?.name : 'None'
        );
        
        // Update session
        currentSession = msg.activeSession;
        
        // Update timer
        if (msg.tracking && currentSession) {
          if (!updateTimer) {
            updateTimer = setInterval(updateTimerDisplay, 1000);
          }
        } else {
          if (updateTimer) {
            clearInterval(updateTimer);
            updateTimer = null;
          }
          document.getElementById('timer-display').textContent = '0h 0m';
        }
        
        // Update summary
        updateSummaryDisplay(msg.files);
      }
    };
  </script>
</body>
</html>


